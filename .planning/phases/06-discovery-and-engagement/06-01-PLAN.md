---
phase: 06-discovery-and-engagement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/+page.server.ts
  - src/routes/+page.svelte
  - src/lib/components/FilterBar.svelte
  - src/lib/components/TrackCard.svelte
autonomous: true

must_haves:
  truths:
    - "Visitor can filter the track listing by content type (track/set/experiment/export) and see only matching tracks"
    - "Visitor can filter the track listing by genre tags and combine with type filters"
    - "Filter state is preserved in the URL as query parameters (shareable, bookmarkable)"
    - "Filters work without JavaScript via GET form progressive enhancement"
    - "AND semantics for tags: selecting ambient + modular shows tracks with BOTH tags"
  artifacts:
    - path: "src/lib/components/FilterBar.svelte"
      provides: "Category select and tag checkbox filter UI"
      min_lines: 30
    - path: "src/routes/+page.server.ts"
      provides: "Dynamic Drizzle query with conditional category and tag filters"
      exports: ["load"]
    - path: "src/routes/+page.svelte"
      provides: "Filter bar integrated above track list"
      contains: "FilterBar"
    - path: "src/lib/components/TrackCard.svelte"
      provides: "Category badge and tag display on listing cards"
      min_lines: 30
  key_links:
    - from: "src/lib/components/FilterBar.svelte"
      to: "URL searchParams"
      via: "goto() from $app/navigation with replaceState"
      pattern: "goto.*replaceState"
    - from: "src/routes/+page.server.ts"
      to: "drizzle-orm"
      via: "and() with conditional filter array and exists() subqueries for tags"
      pattern: "and\\(.*filters"
    - from: "src/routes/+page.svelte"
      to: "src/lib/components/FilterBar.svelte"
      via: "component import passing availableTags, activeCategory, activeTags"
      pattern: "FilterBar"
---

<objective>
Add content type and genre tag filtering to the track listing page.

Purpose: Visitors can narrow down the track listing by category (finished/experiment/set/export) and by genre tags (ambient, techno, modular, etc.) using URL query parameters. This satisfies requirements DISP-04 and DISP-05.

Output: A FilterBar component above the track list, dynamic server-side filtering via Drizzle, and enhanced TrackCards showing category and tags.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discovery-and-engagement/06-RESEARCH.md
@src/lib/server/db/schema.ts
@src/routes/+page.server.ts
@src/routes/+page.svelte
@src/lib/components/TrackCard.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server-side dynamic filtering with URL searchParams</name>
  <files>src/routes/+page.server.ts</files>
  <action>
Rewrite the listing page server load function to read filter state from URL searchParams and build dynamic Drizzle WHERE clauses.

1. Import `and`, `exists`, `sql`, `type SQL` from `drizzle-orm` alongside existing `eq`, `desc`. Import `tags`, `trackTags` from schema.

2. Read filter params in the load function (which receives `{ url }` -- add this param):
   - `const category = url.searchParams.get('category');` (single value: track, set, experiment, export)
   - `const selectedTags = url.searchParams.getAll('tag');` (multiple values via repeated `?tag=ambient&tag=modular`)

3. Build dynamic filter array:
   ```typescript
   const filters: SQL[] = [eq(tracks.status, 'ready')];
   if (category) {
     filters.push(eq(tracks.category, category));
   }
   if (selectedTags.length > 0) {
     for (const tagName of selectedTags) {
       const sq = db
         .select({ x: sql`1` })
         .from(trackTags)
         .innerJoin(tags, eq(trackTags.tagId, tags.id))
         .where(and(eq(trackTags.trackId, tracks.id), eq(tags.name, tagName)));
       filters.push(exists(sq));
     }
   }
   ```

4. Use `and(...filters)` in the `.where()` clause of the tracks query.

5. After querying tracks, fetch tags for each track to display on cards:
   - Query `trackTags` joined with `tags` for all returned track IDs
   - Build a `Map<string, string[]>` mapping trackId to tag names
   - Merge into each track result as a `tags: string[]` field

6. Query available tags for the filter UI:
   ```typescript
   const availableTags = db
     .select({ name: tags.name })
     .from(tags)
     .innerJoin(trackTags, eq(tags.id, trackTags.tagId))
     .innerJoin(tracks, eq(trackTags.trackId, tracks.id))
     .where(eq(tracks.status, 'ready'))
     .groupBy(tags.name)
     .all()
     .map(t => t.name);
   ```

7. Return `{ tracks, availableTags, activeCategory: category, activeTags: selectedTags }`.

CRITICAL: The category enum values are `track`, `set`, `experiment`, `export` (NOT `finished`). The display label "Finished" maps to category value `track`.
  </action>
  <verify>
Run `npm run build` inside the Docker container (`docker exec wallybrain-music npm run build`) to confirm no TypeScript/build errors. Then verify at https://wallyblanchard.com/music that the listing page still loads (no filters active = shows all ready tracks as before).
  </verify>
  <done>
Listing page server load function reads `category` and `tag` query params, builds dynamic WHERE clauses, and returns filtered tracks with their tags and the list of available tags. No filters applied = all ready tracks returned (backward compatible).
  </done>
</task>

<task type="auto">
  <name>Task 2: FilterBar component and TrackCard enhancements</name>
  <files>src/lib/components/FilterBar.svelte, src/lib/components/TrackCard.svelte, src/routes/+page.svelte</files>
  <action>
**FilterBar.svelte (NEW):**

Create a filter bar component that provides category and tag filtering with progressive enhancement.

Props (using `$props()`):
- `availableTags: string[]` -- all tags in use by ready tracks
- `activeCategory: string | null` -- currently selected category
- `activeTags: string[]` -- currently selected tag names

Structure:
1. A `<form method="GET" action="">` wrapping all filter controls (works without JS).
2. Category filter: A row of styled buttons/pills for each category. Values: `track` (label "Finished"), `set` (label "Sets"), `experiment` (label "Experiments"), `export` (label "Exports"). Plus an "All" option that clears the category filter. Use `<button type="submit" name="category" value="track">` pattern for noscript, but with JS use `goto()` for instant updates.
3. Tag filter: Display available tags as toggle-able pill/badge buttons below the category row. Each tag is a clickable badge that adds/removes it from the active tags. Style active tags with a highlight (e.g., `bg-violet-600 text-white` vs `bg-zinc-800 text-zinc-400` for inactive).
4. Active filter indicator: When any filters are active, show a small "Clear all" link that navigates to `?` (removing all params).
5. Use `goto()` from `$app/navigation` with `{ replaceState: true, keepFocus: true }` to update URL when filters change. Build URLSearchParams from current category + tags.
6. Style: Dark theme consistent with existing site -- zinc-800/900 backgrounds, zinc-400 text, violet accents for active states. Compact layout, responsive.
7. Include `<noscript><button type="submit">Filter</button></noscript>` for progressive enhancement.

**TrackCard.svelte (MODIFY):**

1. Update the `track` prop type to include `category: string` and `tags: string[]`.
2. Add a small category badge next to the duration/play count metadata row. Use display labels: `track` -> "Finished", `set` -> "Set", `experiment` -> "Experiment", `export` -> "Export". Style: `text-xs uppercase tracking-wider text-zinc-500`.
3. Show tags as small inline badges after the metadata row if `track.tags.length > 0`. Style: `text-xs bg-zinc-800/50 text-zinc-500 px-1.5 py-0.5 rounded`.

**+page.svelte (MODIFY):**

1. Import `FilterBar` from `$lib/components/FilterBar.svelte`.
2. Place `<FilterBar>` between the header text and the track list, passing `availableTags={data.availableTags}`, `activeCategory={data.activeCategory}`, `activeTags={data.activeTags}`.
3. Update the empty state message: if filters are active, show "No tracks match your filters" with a link to clear filters; if no filters, keep "No tracks yet."
  </action>
  <verify>
Run `npm run build` inside the Docker container to confirm no build errors. Visit https://wallyblanchard.com/music -- FilterBar should appear above track list. Test: click a category pill, URL should update with `?category=track`, page should show only tracks of that category. Click a tag, URL should add `&tag=ambient`, results should narrow. Click "Clear all" to reset.
  </verify>
  <done>
FilterBar component renders category pills and tag toggle badges. Clicking a filter updates URL params via goto() and triggers SvelteKit load re-run with filtered results. TrackCard shows category badge and tag badges. All filter combinations work: category only, tags only, category + tags, no filters.
  </done>
</task>

</tasks>

<verification>
1. Visit https://wallyblanchard.com/music -- page loads showing all ready tracks (no filters)
2. Click "Finished" category pill -- URL becomes `?category=track`, only tracks with category=track display
3. Click a tag badge (e.g., "ambient") -- URL adds `&tag=ambient`, results narrow to tracks matching both category AND tag
4. Click another tag -- results narrow further (AND semantics)
5. Click "All" category -- category removed from URL, showing all categories but still filtered by tags
6. Click "Clear all" -- URL resets to `?`, all tracks display
7. Copy a filtered URL (e.g., `?category=set&tag=modular`), open in new tab -- same filtered results display
8. TrackCard shows category badge and tag badges for each track
</verification>

<success_criteria>
- Listing page filters by category via `?category=` URL param
- Listing page filters by tags via `?tag=` URL params (multiple allowed, AND semantics)
- FilterBar displays all categories and only tags used by ready tracks
- Active filters are visually highlighted
- Filter state is URL-based (shareable, bookmarkable, works without JS)
- TrackCard displays category badge and tag list
- No filters = all ready tracks (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/06-discovery-and-engagement/06-01-SUMMARY.md`
</output>
