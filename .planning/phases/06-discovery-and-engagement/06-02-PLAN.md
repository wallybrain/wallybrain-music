---
phase: 06-discovery-and-engagement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/api/tracks/[id]/play/+server.ts
  - src/lib/components/WaveformPlayer.svelte
  - src/routes/track/[slug]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Track play count increments when a visitor plays a track"
    - "Play count only fires once per page session (debounced via flag, not on every pause/resume)"
    - "Play counts display on both listing and detail pages"
    - "Sharing a track URL on Discord/Twitter shows rich preview with title, description, and cover art"
    - "OG meta tags use absolute URLs including the /music base path and wallyblanchard.com domain"
  artifacts:
    - path: "src/routes/api/tracks/[id]/play/+server.ts"
      provides: "POST endpoint for atomic play count increment"
      exports: ["POST"]
    - path: "src/lib/components/WaveformPlayer.svelte"
      provides: "Play event fires count API once per session"
      contains: "hasCountedPlay"
    - path: "src/routes/track/[slug]/+page.svelte"
      provides: "Open Graph and Twitter Card meta tags"
      contains: "og:title"
  key_links:
    - from: "src/lib/components/WaveformPlayer.svelte"
      to: "/api/tracks/[id]/play"
      via: "fetch POST on first play event"
      pattern: "fetch.*play.*POST"
    - from: "src/routes/api/tracks/[id]/play/+server.ts"
      to: "drizzle-orm"
      via: "atomic sql increment on tracks.playCount"
      pattern: "playCount.*\\+ 1|increment"
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "og:image"
      via: "absolute URL to cover art endpoint"
      pattern: "og:image.*wallyblanchard\\.com"
---

<objective>
Add play count tracking and Open Graph meta tags for social sharing.

Purpose: Track play counts increment anonymously when visitors play tracks (DISP-06), and sharing track URLs on social platforms renders rich previews with title, description, and cover art (SHARE-02).

Output: A play count API endpoint, WaveformPlayer integration with debounced counting, and OG/Twitter Card meta tags on the track detail page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-discovery-and-engagement/06-RESEARCH.md
@src/lib/server/db/schema.ts
@src/lib/components/WaveformPlayer.svelte
@src/routes/track/[slug]/+page.svelte
@src/routes/track/[slug]/+page.server.ts
@src/routes/api/tracks/[id]/art/+server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Play count API endpoint and WaveformPlayer integration</name>
  <files>src/routes/api/tracks/[id]/play/+server.ts, src/lib/components/WaveformPlayer.svelte</files>
  <action>
**Play count API endpoint (NEW): `src/routes/api/tracks/[id]/play/+server.ts`**

Create a POST endpoint that atomically increments a track's play count.

1. Import `RequestHandler` type from `./$types`, `db` from `$lib/server/db/client`, `tracks` from `$lib/server/db/schema`, `eq` and `sql` from `drizzle-orm`, `error` from `@sveltejs/kit`.

2. Export a `POST` handler:
   - Look up the track by `params.id` to confirm it exists: `db.select({ id: tracks.id }).from(tracks).where(eq(tracks.id, params.id)).get()`
   - If not found, `throw error(404, 'Track not found')`
   - Atomically increment play count using `sql` template: `db.update(tracks).set({ playCount: sql\`${tracks.playCount} + 1\` }).where(eq(tracks.id, params.id)).run()`
   - Return `new Response(null, { status: 204 })` (no content)

3. No rate limiting or IP tracking needed -- this is a personal portfolio site, not a monetization platform.

**WaveformPlayer integration (MODIFY): `src/lib/components/WaveformPlayer.svelte`**

Add play count tracking on first play event.

1. Add a `let hasCountedPlay: boolean = $state(false);` variable alongside the existing state variables.

2. Create a handler function:
   ```typescript
   function onPlay() {
     if (!hasCountedPlay) {
       hasCountedPlay = true;
       fetch(`/music/api/tracks/${trackId}/play`, { method: 'POST' });
     }
   }
   ```

3. Wire it to the existing WaveSurfer `play` event. Find the line `ws.on('play', () => (isPlaying = true));` and modify it to also call `onPlay()`:
   ```typescript
   ws.on('play', () => {
     isPlaying = true;
     onPlay();
   });
   ```

4. The `hasCountedPlay` flag naturally resets when the component unmounts (navigating to a different page), so revisiting the track page allows a new count. This is intentional -- each page visit where the user actually plays should count.

5. The fetch is fire-and-forget (no await) -- do not block playback on the API response.

CRITICAL: Use `/music/api/tracks/${trackId}/play` (with `/music` base path prefix) for the fetch URL, matching the pattern used for peaks and audio fetches in the existing component.
  </action>
  <verify>
Run `npm run build` inside the Docker container to confirm no build errors. Then test:
1. Visit a track detail page, play the track -- check Docker logs for the POST request to `/music/api/tracks/{id}/play`
2. Pause and resume -- no additional POST request should fire
3. Verify the play count incremented by refreshing the page and checking the displayed count
4. Directly test the endpoint: `curl -X POST https://wallyblanchard.com/music/api/tracks/{some-track-id}/play` should return 204
  </verify>
  <done>
POST endpoint at `/api/tracks/[id]/play` atomically increments play count. WaveformPlayer fires the endpoint once on first play per page session. Pause/resume does not re-trigger. Play counts display on listing page (via TrackCard) and detail page (already shows `track.playCount`).
  </done>
</task>

<task type="auto">
  <name>Task 2: Open Graph and Twitter Card meta tags on track detail page</name>
  <files>src/routes/track/[slug]/+page.svelte</files>
  <action>
Add Open Graph and Twitter Card meta tags to the track detail page's `<svelte:head>` block for rich social previews.

1. In the existing `<svelte:head>` block (which currently has `<title>` and `<meta name="description">`), add the following meta tags AFTER the existing ones:

   ```svelte
   <!-- Open Graph -->
   <meta property="og:title" content={track.title} />
   <meta property="og:description" content={track.description || `Listen to ${track.title} by wallybrain`} />
   <meta property="og:type" content="music.song" />
   <meta property="og:url" content={`https://wallyblanchard.com/music/track/${track.slug}`} />
   <meta property="og:image" content={`https://wallyblanchard.com/music/api/tracks/${track.id}/art`} />
   <meta property="og:site_name" content="wallybrain" />
   {#if track.duration}
     <meta property="music:duration" content={String(track.duration)} />
   {/if}

   <!-- Twitter Card -->
   <meta name="twitter:card" content="summary_large_image" />
   <meta name="twitter:title" content={track.title} />
   <meta name="twitter:description" content={track.description || `Listen to ${track.title} by wallybrain`} />
   <meta name="twitter:image" content={`https://wallyblanchard.com/music/api/tracks/${track.id}/art`} />
   ```

2. Also add a canonical URL link tag:
   ```svelte
   <link rel="canonical" href={`https://wallyblanchard.com/music/track/${track.slug}`} />
   ```

CRITICAL: All URLs MUST be absolute, starting with `https://wallyblanchard.com/music/`. Do NOT use the `{base}` variable in OG tags -- `{base}` is a relative prefix (`/music`), and social crawlers need full absolute URLs. Hardcode the domain since this is a single-deployment personal site.

The existing cover art endpoint (`/api/tracks/[id]/art`) already returns `Content-Type: image/jpeg` with proper headers, so `og:image` will work directly.

For tracks without cover art, the art endpoint returns 404 -- this is acceptable. Social platforms gracefully handle missing OG images.
  </action>
  <verify>
Run `npm run build` inside the Docker container to confirm no build errors. Then verify OG tags:
1. `curl -s https://wallyblanchard.com/music/track/{some-slug} | grep -i 'og:'` should show all OG meta tags with absolute URLs
2. `curl -s https://wallyblanchard.com/music/track/{some-slug} | grep -i 'twitter:'` should show Twitter Card tags
3. Optionally test with https://opengraph.xyz or the Facebook Sharing Debugger to preview how the link renders
  </verify>
  <done>
Track detail pages include Open Graph (`og:title`, `og:description`, `og:type`, `og:url`, `og:image`, `og:site_name`, `music:duration`) and Twitter Card (`twitter:card`, `twitter:title`, `twitter:description`, `twitter:image`) meta tags with absolute URLs. Social platforms render rich previews when track URLs are shared.
  </done>
</task>

</tasks>

<verification>
1. Play a track -- play count increments (visible after page refresh)
2. Pause and resume -- count does NOT increment again
3. Navigate away and back, play again -- count increments (new page session)
4. `curl -X POST .../api/tracks/{id}/play` returns 204 and increments count
5. `curl -X POST .../api/tracks/nonexistent/play` returns 404
6. View page source of track detail -- OG tags present with absolute wallyblanchard.com URLs
7. OG image URL resolves to the cover art JPEG
8. Test URL in opengraph.xyz or similar tool -- rich preview renders correctly
</verification>

<success_criteria>
- POST `/api/tracks/[id]/play` exists, validates track, increments atomically, returns 204
- WaveformPlayer fires play count once per page session on first play event
- Play counts visible on listing page (TrackCard) and detail page
- Track detail page has complete OG meta tags (title, description, type, url, image, site_name)
- Track detail page has Twitter Card meta tags (card, title, description, image)
- All OG/Twitter URLs are absolute with `https://wallyblanchard.com/music/` prefix
- Canonical URL link tag present
</success_criteria>

<output>
After completion, create `.planning/phases/06-discovery-and-engagement/06-02-SUMMARY.md`
</output>
