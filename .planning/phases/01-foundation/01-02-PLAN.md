---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - wallybrain-music/docker-compose.yml
  - v1be-code-server/docker-compose.yml
  - v1be-code-server/Caddyfile
autonomous: false

must_haves:
  truths:
    - "Visiting wallyblanchard.com/music returns the SvelteKit landing page through Caddy reverse proxy"
    - "The Caddy reverse proxy strips /music prefix before forwarding to the SvelteKit container"
    - "Both the V1be and wallybrain-music containers share a Docker network so Caddy can reach both"
    - "Existing wallyblanchard.com functionality (code-server, Authelia) continues to work"
  artifacts:
    - path: "docker-compose.yml"
      provides: "Music container with external network"
      contains: "webproxy"
    - path: "/home/user/v1be-code-server/docker-compose.yml"
      provides: "V1be stack joined to external network"
      contains: "webproxy"
    - path: "/home/user/v1be-code-server/Caddyfile"
      provides: "Caddy routing for /music/* to wallybrain-music container"
      contains: "handle_path /music/*"
  key_links:
    - from: "v1be-code-server/Caddyfile"
      to: "wallybrain-music container"
      via: "handle_path /music/* -> reverse_proxy wallybrain-music:8800"
      pattern: "reverse_proxy wallybrain-music:8800"
    - from: "v1be-code-server/docker-compose.yml"
      to: "wallybrain-music/docker-compose.yml"
      via: "shared external Docker network 'webproxy'"
      pattern: "webproxy"
---

<objective>
Connect the SvelteKit container to the existing Caddy reverse proxy so the application is reachable at wallyblanchard.com/music.

Purpose: Complete the end-to-end request path from the internet through Caddy to the SvelteKit container, fulfilling INFRA-01 (serve at wallyblanchard.com/music via Caddy).
Output: Updated Caddyfile, shared Docker network, and verified public access.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@/home/user/v1be-code-server/docker-compose.yml
@/home/user/v1be-code-server/Caddyfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared Docker network and update Caddy configuration</name>
  <files>
    /home/user/wallybrain-music/docker-compose.yml
    /home/user/v1be-code-server/docker-compose.yml
    /home/user/v1be-code-server/Caddyfile
  </files>
  <action>
    This task modifies files in TWO projects: wallybrain-music and v1be-code-server. Be careful.

    **Step 1: Create external Docker network**
    Run: `docker network create webproxy`
    If it already exists, that is fine (ignore the error).

    **Step 2: Update wallybrain-music/docker-compose.yml**
    Add network configuration to join the external `webproxy` network:
    ```yaml
    services:
      wallybrain-music:
        # ... existing config from Plan 01 ...
        networks:
          - webproxy

    networks:
      webproxy:
        external: true
    ```

    **Step 3: Update v1be-code-server/docker-compose.yml**
    Add network configuration so all three existing services (code-server, authelia, caddy) join the `webproxy` network. Add to each service:
    ```yaml
    services:
      code-server:
        # ... existing config ...
        networks:
          - webproxy
      authelia:
        # ... existing config ...
        networks:
          - webproxy
      caddy:
        # ... existing config ...
        networks:
          - webproxy

    networks:
      webproxy:
        external: true
    ```

    IMPORTANT: Preserve ALL existing configuration (environment vars, volumes, healthchecks, depends_on, etc.). Only ADD the networks section. Do NOT remove or change anything else.

    **Step 4: Update Caddyfile**
    Edit /home/user/v1be-code-server/Caddyfile to add music routes. The /music routes must be INSIDE the {$DOMAIN} block and BEFORE the catch-all reverse_proxy code-server:8080.

    New Caddyfile:
    ```
    auth.{$DOMAIN} {
        reverse_proxy authelia:9091
    }

    {$DOMAIN} {
        # Public music routes: no auth required
        handle_path /music/* {
            reverse_proxy wallybrain-music:8800
        }

        # Bare /music redirect to /music/ (trailing slash)
        handle /music {
            redir /music/ permanent
        }

        # Everything else: code-server behind Authelia
        forward_auth authelia:9091 {
            uri /api/authz/forward-auth
            copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
        }
        reverse_proxy code-server:8080
    }
    ```

    Key decisions:
    - Use `handle_path /music/*` (not `handle`) because path stripping is needed and no auth is required for public routes (admin auth comes in Phase 5).
    - Add a `handle /music` block to redirect bare /music to /music/ so SvelteKit gets a clean root route.
    - Music routes are public -- no forward_auth. The existing forward_auth + code-server block handles everything else.

    **Step 5: Restart all containers**
    The order matters to avoid downtime:

    1. Stop the wallybrain-music container: `docker compose -f /home/user/wallybrain-music/docker-compose.yml down`
    2. Stop the V1be stack: `docker compose -f /home/user/v1be-code-server/docker-compose.yml down`
    3. Start the V1be stack (now on webproxy network): `docker compose -f /home/user/v1be-code-server/docker-compose.yml up -d`
    4. Wait for V1be stack to be healthy (Caddy, Authelia, code-server)
    5. Start the wallybrain-music container: `docker compose -f /home/user/wallybrain-music/docker-compose.yml up -d`
    6. Wait for wallybrain-music to be healthy

    **Step 6: Verify network connectivity**
    - `docker network inspect webproxy` should show all 4 containers (caddy, authelia, code-server, wallybrain-music)
    - `docker exec caddy wget -qO- http://wallybrain-music:8800/music/health` should return "OK" (Caddy can reach music container by name)

    **Step 7: Verify Caddy routing**
    - `curl -k https://localhost/music/` or `curl http://localhost:80/music/` -- check that Caddy forwards to the music app (may need to test from the server or use the public URL)
    - If curl to localhost doesn't work due to SSL/domain, verify via: `docker exec caddy wget -qO- http://wallybrain-music:8800/music/` should return HTML with "wallybrain"

    **Rollback plan:** If something breaks, restore the original Caddyfile and docker-compose.yml from git (v1be-code-server repo) and restart.
  </action>
  <verify>
    1. `docker network inspect webproxy --format '{{range .Containers}}{{.Name}} {{end}}'` shows caddy, authelia, code-server, wallybrain-music
    2. `docker exec caddy wget -qO- http://wallybrain-music:8800/music/health` returns "OK"
    3. `docker compose -f /home/user/v1be-code-server/docker-compose.yml ps` shows all 3 services healthy
    4. `docker compose -f /home/user/wallybrain-music/docker-compose.yml ps` shows wallybrain-music healthy
  </verify>
  <done>
    All four containers share the webproxy Docker network. Caddy can reach the wallybrain-music container by hostname. Caddyfile routes /music/* to the SvelteKit container with path stripping. Existing V1be stack (code-server + Authelia) continues to function.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete foundation: SvelteKit application running in Docker, connected to SQLite database, served at wallyblanchard.com/music through Caddy reverse proxy with path stripping. The music routes are public (no auth), while the rest of wallyblanchard.com remains behind Authelia 2FA.
  </what-built>
  <how-to-verify>
    1. Open https://wallyblanchard.com/music/ in a browser (NOT logged into Authelia)
       - Expected: See a dark page with "wallybrain" heading and "music platform" subtitle
       - The page should load WITHOUT requiring Authelia login (public route)

    2. Open https://wallyblanchard.com/ in a browser
       - Expected: Redirects to Authelia login (existing behavior preserved)

    3. Open https://wallyblanchard.com/music/health in a browser
       - Expected: See "OK" text (database health check passing)

    4. Verify the page shows "0 tracks" (confirming database query works, just no tracks yet)
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 is complete when ALL of these are true:
1. wallyblanchard.com/music returns the SvelteKit landing page (served through Caddy, public -- no auth)
2. wallyblanchard.com/music/health returns "OK" (database connectivity confirmed)
3. SQLite database at /home/user/wallybrain-music/data/db/music.db has tracks, tags, track_tags tables
4. Storage directories exist: data/audio/, data/peaks/, data/art/
5. wallybrain-music Docker container shows "healthy" status
6. Existing wallyblanchard.com functionality (code-server, Authelia) is unaffected
</verification>

<success_criteria>
- INFRA-01: wallyblanchard.com/music serves the SvelteKit application through Caddy reverse proxy (public, no auth)
- INFRA-02: Filesystem storage directories (audio, peaks, art) exist and are writable inside the Docker volume
- INFRA-05: Docker container runs with restart: unless-stopped, passes health checks, persists data across restarts
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
