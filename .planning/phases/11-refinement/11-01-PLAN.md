---
phase: 11-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/+layout.svelte
  - src/app.css
  - src/lib/components/PersistentPlayer.svelte
  - src/lib/components/CoverArt.svelte
autonomous: true

must_haves:
  truths:
    - "Navigating between pages shows a smooth crossfade instead of a hard page swap"
    - "The persistent player bar remains stable (no flicker/ghost) during page transitions"
    - "Hovering over cover art on track cards triggers a subtle zoom within the card boundary"
    - "Cover art on the track detail page (lg size) does NOT zoom on hover"
    - "Users with prefers-reduced-motion see no transition animation"
  artifacts:
    - path: "src/routes/+layout.svelte"
      provides: "onNavigate view transition integration"
      contains: "onNavigate"
    - path: "src/app.css"
      provides: "View transition keyframes and player-bar exclusion CSS"
      contains: "view-transition"
    - path: "src/lib/components/PersistentPlayer.svelte"
      provides: "view-transition-name isolation on player bar"
      contains: "view-transition-name"
    - path: "src/lib/components/CoverArt.svelte"
      provides: "Hover zoom on sm size cover art with overflow-hidden"
      contains: "group-hover:scale-110"
  key_links:
    - from: "src/routes/+layout.svelte"
      to: "document.startViewTransition"
      via: "onNavigate callback"
      pattern: "startViewTransition"
    - from: "src/lib/components/PersistentPlayer.svelte"
      to: "src/app.css"
      via: "view-transition-name: player-bar matches CSS pseudo-element selectors"
      pattern: "player-bar"
    - from: "src/lib/components/CoverArt.svelte"
      to: "TrackCard group hover"
      via: "group-hover:scale-110 triggers from TrackCard's group class"
      pattern: "group-hover"
---

<objective>
Add smooth page transitions via the View Transitions API and a hover zoom effect on track card cover art.

Purpose: Replace jarring hard page swaps with polished crossfade transitions, and add a subtle interactive zoom on cover art thumbnails to make the track listing feel more responsive and engaging.
Output: Modified +layout.svelte with onNavigate hook, view transition CSS in app.css, isolated PersistentPlayer, and zoom-enabled CoverArt.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-refinement/11-RESEARCH.md

@src/routes/+layout.svelte
@src/app.css
@src/lib/components/PersistentPlayer.svelte
@src/lib/components/CoverArt.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: View Transitions API integration and persistent player isolation</name>
  <files>
    src/routes/+layout.svelte
    src/app.css
    src/lib/components/PersistentPlayer.svelte
  </files>
  <action>
    In `src/routes/+layout.svelte`:
    - Import `onNavigate` from `$app/navigation`
    - Add the onNavigate callback that feature-detects `document.startViewTransition`, returns a Promise that resolves inside the transition callback, and awaits `navigation.complete`. Exact pattern from research:
      ```
      onNavigate((navigation) => {
        if (!document.startViewTransition) return;
        return new Promise((resolve) => {
          document.startViewTransition(async () => {
            resolve();
            await navigation.complete;
          });
        });
      });
      ```
    - Do NOT add any TypeScript type assertion -- TS 5.9.3 has native `startViewTransition` types

    In `src/app.css`, after the existing `@keyframes eq3` block and before `@layer base`:
    - Add view transition keyframes:
      - `@keyframes vt-fade-in { from { opacity: 0; } }`
      - `@keyframes vt-fade-out { to { opacity: 0; } }`
    - Add `::view-transition-old(root)` with `animation: 150ms cubic-bezier(0.4, 0, 1, 1) both vt-fade-out`
    - Add `::view-transition-new(root)` with `animation: 150ms cubic-bezier(0, 0, 0.2, 1) 50ms both vt-fade-in`
    - Add player bar isolation:
      ```css
      ::view-transition-old(player-bar),
      ::view-transition-new(player-bar) {
        animation: none;
      }
      ```
    - Add reduced motion override:
      ```css
      @media (prefers-reduced-motion: reduce) {
        ::view-transition-old(root),
        ::view-transition-new(root) {
          animation: none;
        }
      }
      ```

    In `src/lib/components/PersistentPlayer.svelte`:
    - Add `style="view-transition-name: player-bar;"` to the root `<div>` element (the fixed-position container on line 93)
    - This prevents the player bar from being captured in the root transition snapshot, eliminating ghost/flicker
  </action>
  <verify>
    `npm run build` succeeds. `npm run check` passes (or only pre-existing errors). Grep confirms:
    - `onNavigate` imported in +layout.svelte
    - `view-transition` CSS rules in app.css
    - `view-transition-name: player-bar` in PersistentPlayer.svelte
  </verify>
  <done>
    Page navigation triggers a 150ms crossfade transition. The persistent player bar stays rock-solid during transitions (no flicker). Unsupported browsers fall back to instant navigation. prefers-reduced-motion users see no animation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Cover art hover zoom on track cards</name>
  <files>
    src/lib/components/CoverArt.svelte
  </files>
  <action>
    Modify `src/lib/components/CoverArt.svelte` to add a hover zoom effect on the `sm` size variant (used in TrackCard list view). The zoom MUST NOT apply to `lg` size (track detail page -- sits above WaveformPlayer).

    For the `{#if artPath}` branch:
    - Wrap the `<img>` in a container `<div>` with classes: `{sizeClasses[size]} rounded-lg overflow-hidden shrink-0` and conditionally add shadow classes: `{size === 'lg' ? '' : 'shadow-lg shadow-black/40'}`. Apply `style={glowStyle}` to this container div.
    - Move `shrink-0` from the img to the container div (the div is the layout participant now).
    - Change the `<img>` classes to: `w-full h-full object-cover` plus conditional zoom classes.
    - Add a derived `enableZoom` that is `true` when `size === 'sm'`.
    - When `enableZoom` is true, add `transition-transform duration-300 group-hover:scale-110` to the img.
    - The `group-hover` works because TrackCard's `<a>` already has the `group` class.

    For the `{:else}` placeholder branch:
    - Add `shrink-0` to the placeholder div if not already present (it already has it via the existing classes).
    - No zoom needed on placeholder.

    CRITICAL SAFETY: The `transform` is on the `<img>` element INSIDE CoverArt. TrackCard does NOT contain any WaveformPlayer. The `lg` size CoverArt (track detail page) does NOT get the zoom. This is safe for drag-to-seek.
  </action>
  <verify>
    `npm run build` succeeds. Grep confirms `group-hover:scale-110` and `overflow-hidden` in CoverArt.svelte. Verify the zoom is conditional on `size === 'sm'` (not applied to lg).
  </verify>
  <done>
    Hovering over cover art in the track listing (sm size) triggers a subtle 110% scale zoom clipped within the rounded card boundary. Cover art on the track detail page (lg size) has no hover zoom. No waveform drag-to-seek breakage.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no new errors
- `npm run check` passes (or only pre-existing errors)
- +layout.svelte contains `onNavigate` and `startViewTransition` integration
- app.css contains `::view-transition-old(root)` and `::view-transition-new(root)` keyframe rules
- app.css contains `::view-transition-old(player-bar)` with `animation: none`
- app.css contains `@media (prefers-reduced-motion: reduce)` override
- PersistentPlayer.svelte root div has `view-transition-name: player-bar`
- CoverArt.svelte has `overflow-hidden` container and `group-hover:scale-110` conditional on `sm` size
</verification>

<success_criteria>
- Page transitions show smooth crossfade (150ms) on navigation between any pages
- Persistent player bar does not flicker or ghost during transitions
- Cover art thumbnails in track listing zoom subtly on hover
- Cover art on track detail page does NOT zoom on hover
- No waveform drag-to-seek breakage (transforms only on img, not waveform ancestors)
- Build succeeds, no new type errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-refinement/11-01-SUMMARY.md`
</output>
