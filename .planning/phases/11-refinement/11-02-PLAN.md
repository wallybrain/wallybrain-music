---
phase: 11-refinement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/stores/layoutPreference.svelte.ts
  - src/lib/components/TrackCardGrid.svelte
  - src/routes/+page.svelte
autonomous: true

must_haves:
  truths:
    - "User can toggle between grid and list views on the track listing page"
    - "The chosen layout persists across page loads via localStorage"
    - "Grid view shows track cards in a responsive 2-column (mobile) / 3-column (sm+) grid with vertical card layout"
    - "List view remains identical to the current horizontal card layout with staggered entrance"
    - "Grid cards show cover art prominently with title and metadata below"
    - "Currently-playing track is visually distinguishable in both grid and list views"
    - "Grid cards have a play button overlay on cover art hover"
  artifacts:
    - path: "src/lib/stores/layoutPreference.svelte.ts"
      provides: "Persisted grid/list preference using Svelte 5 $state + localStorage"
      exports: ["layoutPreference"]
    - path: "src/lib/components/TrackCardGrid.svelte"
      provides: "Vertical card layout for grid view with cover art, title, metadata, play overlay"
      min_lines: 40
    - path: "src/routes/+page.svelte"
      provides: "Layout toggle UI and conditional grid/list rendering"
      contains: "layoutPreference"
  key_links:
    - from: "src/routes/+page.svelte"
      to: "src/lib/stores/layoutPreference.svelte.ts"
      via: "import and reactive mode check"
      pattern: "layoutPreference\\.mode"
    - from: "src/routes/+page.svelte"
      to: "src/lib/components/TrackCardGrid.svelte"
      via: "conditional render in grid mode"
      pattern: "TrackCardGrid"
    - from: "src/lib/stores/layoutPreference.svelte.ts"
      to: "localStorage"
      via: "read on construct, write on toggle/setMode"
      pattern: "localStorage"
---

<objective>
Add a grid/list layout toggle to the track listing page with a persistent user preference.

Purpose: Give users the choice between a compact list view (existing) and a visual grid view that showcases cover art prominently. The preference persists via localStorage so the layout sticks across visits.
Output: New layoutPreference store, new TrackCardGrid component, and modified +page.svelte with toggle UI and conditional rendering.
</objective>

<execution_context>
@./.claude/agents/gsd-planner.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-refinement/11-RESEARCH.md

@src/routes/+page.svelte
@src/lib/stores/playerState.svelte.ts
@src/lib/components/TrackCard.svelte
@src/lib/components/EqIndicator.svelte
@src/lib/utils/formatTime.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Layout preference store and grid card component</name>
  <files>
    src/lib/stores/layoutPreference.svelte.ts
    src/lib/components/TrackCardGrid.svelte
  </files>
  <action>
    Create `src/lib/stores/layoutPreference.svelte.ts` following the exact same class-based pattern as `playerState.svelte.ts`:
    - Define `type LayoutMode = 'list' | 'grid'`
    - Define `STORAGE_KEY = 'wallybrain-layout'`
    - Class `LayoutPreference` with `mode: LayoutMode = $state('list')`
    - Constructor reads localStorage (guarded by `browser` from `$app/environment`), validates stored value is 'grid' or 'list'
    - `toggle()` method flips mode and writes to localStorage (guarded by `browser`)
    - `setMode(mode: LayoutMode)` method sets mode and writes to localStorage
    - Export singleton `layoutPreference = new LayoutPreference()`

    Create `src/lib/components/TrackCardGrid.svelte` -- a vertical card variant for grid view:
    - Accept same props as TrackCard: `track` (with same shape including dominantColor), `allTracks` (QueueTrack[]), `index` (number)
    - Import `formatTime`, `base`, `playerState`, `QueueTrack` type, `EqIndicator`
    - Define same `categoryLabels` map as TrackCard
    - Derive `isCurrentTrack` and `isPlaying` from playerState (same pattern as TrackCard)
    - Implement `handlePlay` and `handleToggle` functions (same as TrackCard)
    - Layout: `<a>` wrapping a vertical flex column with `group` class:
      - Top section: `relative aspect-square overflow-hidden` container
        - If artPath: `<img>` with `w-full h-full object-cover transition-transform duration-300 group-hover:scale-110` and `loading="lazy"`
        - If no artPath: gradient placeholder using `bg-gradient-to-br from-surface-overlay to-surface-hover` with large music note icon
        - Play/pause button overlay: absolute positioned, centered, `opacity-0 group-hover:opacity-100` transition, semi-transparent dark background circle. Show pause icon if `isPlaying`, play icon otherwise. Wire to `handleToggle` or `handlePlay` accordingly.
        - If `isPlaying`: show EqIndicator in top-right corner of the cover art area (absolute positioned, small accent background pill)
      - Bottom section: `p-3` padding
        - Title: `text-sm font-medium text-text-secondary truncate group-hover:text-text-primary transition-colors`
        - Metadata row: `flex items-center gap-2 text-xs text-text-muted mt-1` with duration (font-mono tabular-nums) and category (uppercase tracking-wider)
    - Card container classes: `flex flex-col rounded-lg bg-surface-raised hover:bg-surface-hover transition-all overflow-hidden`
    - If `isCurrentTrack` (playing or paused): add a subtle accent ring `ring-1 ring-accent/30` to distinguish the current track in grid view
  </action>
  <verify>
    `npm run build` succeeds. `npm run check` passes (or pre-existing errors only). Verify:
    - layoutPreference.svelte.ts exports `layoutPreference` with `mode`, `toggle()`, `setMode()`
    - TrackCardGrid.svelte renders vertical card with cover art, title, metadata
    - TrackCardGrid has play button overlay and EqIndicator for playing state
  </verify>
  <done>
    Layout preference store persists 'grid'/'list' to localStorage and provides reactive mode state. Grid card component shows vertical layout with prominent cover art, play overlay on hover, EqIndicator for playing tracks, and accent ring for current track.
  </done>
</task>

<task type="auto">
  <name>Task 2: Layout toggle UI and conditional grid/list rendering on home page</name>
  <files>
    src/routes/+page.svelte
  </files>
  <action>
    Modify `src/routes/+page.svelte` to add the layout toggle and conditional rendering:

    Add imports:
    - `import { layoutPreference } from '$lib/stores/layoutPreference.svelte';`
    - `import TrackCardGrid from '$lib/components/TrackCardGrid.svelte';`

    Add toggle UI between the FilterBar and the track listing (after the `<FilterBar />` component, before the `{#if data.tracks.length === 0}` block):
    - A flex container aligned right: `<div class="flex justify-end mb-3">`
    - Inside: a toggle button group with `bg-surface-overlay rounded-lg p-0.5 flex items-center gap-1`
    - Two buttons:
      1. List view button: calls `layoutPreference.setMode('list')`, highlighted when mode is 'list' (`bg-surface-hover text-text-primary` vs `text-text-muted hover:text-text-secondary`), with `aria-label="List view"` and `aria-pressed={layoutPreference.mode === 'list'}`
        - SVG icon: 3 horizontal lines (list icon) -- `<svg class="w-4 h-4" fill="none" viewBox="0 0 16 16" stroke="currentColor" stroke-width="2"><line x1="1" y1="4" x2="15" y2="4"/><line x1="1" y1="8" x2="15" y2="8"/><line x1="1" y1="12" x2="15" y2="12"/></svg>`
      2. Grid view button: calls `layoutPreference.setMode('grid')`, highlighted when mode is 'grid', with `aria-label="Grid view"` and `aria-pressed={layoutPreference.mode === 'grid'}`
        - SVG icon: 4 squares (grid icon) -- `<svg class="w-4 h-4" fill="none" viewBox="0 0 16 16" stroke="currentColor" stroke-width="2"><rect x="1" y="1" width="5.5" height="5.5" rx="1"/><rect x="9.5" y="1" width="5.5" height="5.5" rx="1"/><rect x="1" y="9.5" width="5.5" height="5.5" rx="1"/><rect x="9.5" y="9.5" width="5.5" height="5.5" rx="1"/></svg>`

    Modify the track listing section (the `{:else}` branch where tracks exist):
    - Wrap in a conditional on `layoutPreference.mode`:
      - If `'grid'`: render `<div class="grid grid-cols-2 sm:grid-cols-3 gap-3">` with `{#each data.tracks as track, i (track.id)}` rendering `<TrackCardGrid {track} allTracks={queueTracks} index={i} />`
      - If `'list'`: keep the existing `<div class="space-y-3">` with the `in:fly` staggered entrance and `<TrackCard>` rendering exactly as-is

    IMPORTANT: The staggered `in:fly` entrance animation stays on the LIST view only. Grid view does NOT need staggered entrance (the grid layout itself provides visual structure). Do NOT animate layout switches with view transitions -- view transitions are for page navigation only.
  </action>
  <verify>
    `npm run build` succeeds. `npm run check` passes (or pre-existing errors only). Verify:
    - +page.svelte imports both `layoutPreference` and `TrackCardGrid`
    - Toggle button group renders with list/grid icons and aria attributes
    - Conditional rendering switches between grid (TrackCardGrid) and list (TrackCard) views
    - List view still has staggered `in:fly` entrance
  </verify>
  <done>
    Track listing page shows a list/grid toggle button. Clicking grid switches to a responsive 2-3 column grid of vertical cards. Clicking list returns to the existing horizontal card layout with staggered entrance. Preference persists across page loads. Both views are polished and responsive.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no new errors
- `npm run check` passes (or only pre-existing errors)
- layoutPreference.svelte.ts exists, exports singleton with mode/toggle/setMode
- TrackCardGrid.svelte exists with vertical card layout, play overlay, EqIndicator
- +page.svelte has toggle UI with list/grid buttons and conditional rendering
- localStorage key 'wallybrain-layout' is read on construct and written on toggle/setMode
- Grid view shows 2 cols on mobile, 3 cols on sm+
- List view is unchanged (same TrackCard + staggered fly entrance)
- Currently-playing track distinguishable in both views
</verification>

<success_criteria>
- Toggle between grid and list views works on the track listing page
- Grid view shows responsive 2-3 column layout with vertical cards featuring prominent cover art
- List view is identical to the previous layout (horizontal cards with staggered entrance)
- Layout preference persists across page refreshes (stored in localStorage)
- Currently-playing track has visual indicator in both views (EqIndicator in list, EqIndicator + accent ring in grid)
- Play/pause works from both grid and list views
- Build succeeds, no new type errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-refinement/11-02-SUMMARY.md`
</output>
