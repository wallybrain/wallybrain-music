---
phase: 04-track-pages
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/routes/track/[slug]/+page.server.ts
  - src/routes/track/[slug]/+page.svelte
  - src/routes/+layout.svelte
  - src/app.css
autonomous: true

must_haves:
  truths:
    - "Visitor can click a track to view its detail page with description, liner notes, and the waveform player"
    - "Each track has a unique permalink URL (/music/track/slug) that can be bookmarked and shared"
    - "The entire interface uses a dark/moody aesthetic appropriate for electronic music"
    - "All pages render correctly and are usable on mobile, tablet, and desktop screen sizes"
  artifacts:
    - path: "src/routes/track/[slug]/+page.server.ts"
      provides: "Server-side track load by slug with 404 for non-ready tracks"
      exports: ["load"]
    - path: "src/routes/track/[slug]/+page.svelte"
      provides: "Track detail page with cover art, metadata, waveform player, description"
      min_lines: 40
    - path: "src/routes/+layout.svelte"
      provides: "Root layout with dark background applied globally"
      min_lines: 5
    - path: "src/app.css"
      provides: "Global CSS with Tailwind import and base dark styles"
      min_lines: 3
  key_links:
    - from: "src/routes/track/[slug]/+page.server.ts"
      to: "tracks table"
      via: "drizzle query by slug where status is ready"
      pattern: "eq\\(tracks\\.slug.*params\\.slug\\)"
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "src/lib/components/WaveformPlayer.svelte"
      via: "component import with trackId prop"
      pattern: "import WaveformPlayer"
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "src/lib/components/CoverArt.svelte"
      via: "component import with trackId and artPath props"
      pattern: "import CoverArt"
    - from: "src/routes/+page.svelte"
      to: "src/routes/track/[slug]/+page.svelte"
      via: "TrackCard links to {base}/track/{slug}"
      pattern: "base.*track.*slug"
---

<objective>
Track detail page with slug-based permalinks and dark/moody visual design system.

Purpose: Give each track a dedicated page at /music/track/{slug} with cover art, waveform player, description/liner notes, and metadata. Establish the dark theme globally so all pages (listing, detail, error) share a cohesive dark/moody electronic music aesthetic with responsive layouts.

Output: Working detail pages at /music/track/{slug}, global dark theme, responsive design at mobile/tablet/desktop breakpoints.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-track-pages/04-RESEARCH.md
@.planning/phases/04-track-pages/04-01-SUMMARY.md

@src/lib/components/WaveformPlayer.svelte
@src/lib/components/CoverArt.svelte
@src/lib/server/db/schema.ts
@src/lib/utils/formatTime.ts
@src/routes/+layout.svelte
@src/routes/+page.svelte
@src/app.css
@src/app.html
@svelte.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track detail page with slug-based routing</name>
  <files>
    src/routes/track/[slug]/+page.server.ts
    src/routes/track/[slug]/+page.svelte
  </files>
  <action>
    **Server load function** at `src/routes/track/[slug]/+page.server.ts`:
    - Import `db` from `$lib/server/db/client`, `tracks` from `$lib/server/db/schema`, `eq` from `drizzle-orm`, `error` from `@sveltejs/kit`
    - Type the load function with `PageServerLoad` from `./$types`
    - Query: `db.select().from(tracks).where(eq(tracks.slug, params.slug)).get()`
    - If track not found OR `track.status !== 'ready'`, throw `error(404, 'Track not found')`
    - Return `{ track }` (the full track row -- detail page needs all fields)

    **Detail page component** at `src/routes/track/[slug]/+page.svelte`:
    - Svelte 5 with `$props()` runes: `let { data } = $props()`
    - Import `WaveformPlayer` from `$lib/components/WaveformPlayer.svelte`
    - Import `CoverArt` from `$lib/components/CoverArt.svelte`
    - Import `formatTime` from `$lib/utils/formatTime`
    - Import `base` from `$app/paths`

    **`<svelte:head>` section:**
    - `<title>{track.title} - wallybrain</title>`
    - `<meta name="description" content={track.description || 'Listen to ' + track.title + ' by wallybrain'} />`

    **Page layout** (mobile-first, responsive):
    - Outer: `max-w-3xl mx-auto px-4 py-8`
    - Back link: `<a href="{base}/">` with text "Back to tracks", styled as `text-zinc-500 hover:text-zinc-300 text-sm mb-6 inline-block` with a left arrow entity `&larr;`
    - **Header section:** `flex flex-col md:flex-row gap-6 mb-8`
      - Left: `CoverArt` component with `size="lg"` (stacks on mobile, side-by-side on md+)
      - Right (`flex-1`):
        - Track title as `h1` (text-2xl md:text-3xl font-bold text-white mb-2)
        - Category badge: `<span>` with text-xs uppercase tracking-wider, bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded. Show `track.category` value.
        - Duration (if not null): `<p class="text-zinc-400 text-sm mt-2">` with formatTime
        - Play count: `<p class="text-zinc-500 text-xs mt-1">` with "{track.playCount} plays"

    **Waveform player section:**
    - `<div class="mb-8">` containing `<WaveformPlayer trackId={track.id} duration={track.duration ?? 0} />`

    **Description section** (only if track.description is truthy):
    - `<div class="mt-8">`
    - Heading: "About this track" as h2 (text-lg font-semibold text-zinc-300 mb-3)
    - Description text: `<p class="text-zinc-400 whitespace-pre-wrap leading-relaxed">{track.description}</p>`
    - Render as plain text with whitespace-pre-wrap (no Markdown parsing)

    **Track info footer:**
    - `<div class="mt-8 pt-6 border-t border-zinc-800/50">`
    - Small meta info row: "Added {formatted date}" in text-xs text-zinc-600
    - Format createdAt: use `new Date(track.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })`
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` for zero TypeScript errors. Rebuild Docker container. Verify that navigating to /music/track/{slug-of-existing-track} renders the detail page with the track title. Verify /music/track/nonexistent returns 404 error page.
  </verify>
  <done>
    Each ready track has a working detail page at /music/track/{slug} showing cover art, title, category, duration, play count, waveform player, and description. Non-ready or nonexistent slugs return 404.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dark theme global styles and responsive layout polish</name>
  <files>
    src/routes/+layout.svelte
    src/app.css
  </files>
  <action>
    **Update app.css** at `src/app.css`:
    - Keep the existing `@import "tailwindcss";` line
    - Add base layer styles to set the global dark background and text color on the html/body elements, so ALL pages inherit the dark theme without repeating `bg-zinc-950` on every page:
      ```css
      @layer base {
        html {
          background-color: var(--color-zinc-950);
          color: var(--color-zinc-200);
        }
      }
      ```
    - Add smooth scrolling: `html { scroll-behavior: smooth; }`
    - Add custom scrollbar styling for webkit browsers to match dark theme:
      ```css
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: var(--color-zinc-900); }
      ::-webkit-scrollbar-thumb { background: var(--color-zinc-700); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--color-zinc-600); }
      ```

    **Update +layout.svelte** at `src/routes/+layout.svelte`:
    - Keep existing structure: `$props()` children pattern, app.css import
    - Wrap `{@render children()}` in a `<div class="min-h-screen flex flex-col">` to establish the full-height layout (Phase 7 will add a persistent bottom bar as a sibling)
    - Add a simple header/nav area: `<header class="max-w-3xl mx-auto w-full px-4 pt-6 pb-2">` with a link to `{base}/` showing "wallybrain" in `text-lg font-semibold text-zinc-300 hover:text-white transition-colors`
    - Import `base` from `$app/paths`
    - Wrap children in `<main class="flex-1">` so content fills available space
    - This means the individual pages (+page.svelte) should NOT repeat the "wallybrain" h1 heading -- it will be in the layout. Update this understanding: the listing page (+page.svelte from 04-01) has its own h1. The layout header is a small nav link, NOT a duplicate h1. The listing page keeps its h1 title but can be simplified since the layout provides the brand link.

    **Note on Phase 7 readiness:** The `flex flex-col` layout with `flex-1` main allows a future persistent player bar to be added as a sibling after `</main>` without disrupting existing layout. Do NOT add bottom padding (pb-20) yet -- that is Phase 7's concern.

    **Responsive verification mental model:**
    - Mobile (< 640px): Single column, cover art stacks above info on detail page, full-width cards
    - Tablet (md: 768px+): Cover art and info side-by-side on detail page, wider padding
    - Desktop (lg: 1024px+): max-w-3xl centered content, comfortable reading width
    - All breakpoints handled by existing Tailwind responsive prefixes in the components (md:flex-row, md:text-3xl, md:w-32 h-32, etc.)
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` for zero TypeScript errors. Rebuild Docker container. Verify that the listing page and detail page both render with the dark zinc-950 background. Verify the layout header shows "wallybrain" as a link. Curl the listing page and detail page to confirm they return 200 with expected HTML structure.
  </verify>
  <done>
    Global dark theme applied via CSS base layer (no per-page bg-zinc-950 needed). Layout provides consistent navigation header and flex-column structure ready for Phase 7 persistent player. Scrollbar styled to match dark theme. Responsive layouts work across mobile, tablet, and desktop.
  </done>
</task>

</tasks>

<verification>
1. `npx svelte-check --tsconfig ./tsconfig.json` reports 0 errors
2. Docker container builds and starts healthy
3. GET /music/ returns listing page with dark background, "wallybrain" nav link
4. GET /music/track/{valid-slug} returns detail page with title, cover art, waveform player
5. GET /music/track/{valid-slug} page has `<title>` tag with track title
6. GET /music/track/nonexistent returns 404 error page
7. Both listing and detail pages have dark zinc-950 background
8. Layout header is visible on both listing and detail pages
</verification>

<success_criteria>
- Track detail page renders at /music/track/{slug} with cover art, waveform player, description, metadata
- Non-ready and nonexistent slugs return 404 via custom error page
- Global dark theme applies to all pages through CSS base layer
- Layout provides consistent nav header with "wallybrain" brand link
- Layout flex structure supports future Phase 7 persistent player bar
- Responsive design: stacked on mobile, side-by-side on tablet+
- svelte:head provides per-page title and meta description on detail page
</success_criteria>

<output>
After completion, create `.planning/phases/04-track-pages/04-02-SUMMARY.md`
</output>
