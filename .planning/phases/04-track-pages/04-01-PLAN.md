---
phase: 04-track-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/api/tracks/[id]/art/+server.ts
  - src/lib/components/CoverArt.svelte
  - src/lib/components/TrackCard.svelte
  - src/routes/+page.server.ts
  - src/routes/+page.svelte
  - src/routes/+error.svelte
autonomous: true

must_haves:
  truths:
    - "Track listing page shows all published tracks with cover art, title, duration, and play count"
    - "Tracks without cover art display a styled placeholder instead of a broken image"
    - "Invalid URLs show a custom error page with a link back to the track listing"
  artifacts:
    - path: "src/routes/api/tracks/[id]/art/+server.ts"
      provides: "Cover art image serving endpoint"
      exports: ["GET"]
    - path: "src/lib/components/CoverArt.svelte"
      provides: "Reusable cover art image with fallback placeholder"
      min_lines: 15
    - path: "src/lib/components/TrackCard.svelte"
      provides: "Track card component for listing page"
      min_lines: 20
    - path: "src/routes/+page.svelte"
      provides: "Track listing page with card layout (no WaveformPlayer instances)"
      min_lines: 15
    - path: "src/routes/+error.svelte"
      provides: "Custom 404 error page with dark theme"
      min_lines: 10
  key_links:
    - from: "src/lib/components/CoverArt.svelte"
      to: "/api/tracks/[id]/art"
      via: "img src attribute"
      pattern: "api/tracks.*art"
    - from: "src/lib/components/TrackCard.svelte"
      to: "src/lib/components/CoverArt.svelte"
      via: "component import"
      pattern: "import CoverArt"
    - from: "src/routes/+page.svelte"
      to: "src/lib/components/TrackCard.svelte"
      via: "component import"
      pattern: "import TrackCard"
    - from: "src/routes/+page.server.ts"
      to: "tracks table"
      via: "drizzle query selecting artPath, playCount, createdAt"
      pattern: "tracks\\.artPath|tracks\\.playCount"
---

<objective>
Cover art API endpoint, reusable components (CoverArt, TrackCard), and track listing page rewrite.

Purpose: Replace the Phase 3 prototype listing (which mounts a WaveformPlayer per track) with a proper card-based track listing showing cover art, title, duration, and play count. Create the cover art serving endpoint and reusable components that the detail page (Plan 04-02) will also use.

Output: Working track listing at /music with card layout, cover art endpoint, CoverArt and TrackCard components, custom error page.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-track-pages/04-RESEARCH.md

@src/routes/api/tracks/[id]/audio/+server.ts
@src/routes/+page.server.ts
@src/routes/+page.svelte
@src/routes/+layout.svelte
@src/lib/server/db/schema.ts
@src/lib/utils/formatTime.ts
@src/app.css
@svelte.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cover art API endpoint and CoverArt component</name>
  <files>
    src/routes/api/tracks/[id]/art/+server.ts
    src/lib/components/CoverArt.svelte
  </files>
  <action>
    **Cover art endpoint** at `src/routes/api/tracks/[id]/art/+server.ts`:
    - Follow the exact same pattern as the audio endpoint (`src/routes/api/tracks/[id]/audio/+server.ts`)
    - GET handler: look up track by `params.id` using Drizzle, selecting only `artPath`
    - If track not found OR artPath is null, throw `error(404, 'Cover art not found')`
    - Use `statSync` to get file size (catch error -> 404 if file missing on disk)
    - Stream the file using `createReadStream` + `Readable.toWeb()` as ReadableStream
    - Headers: `Content-Type: image/jpeg`, `Content-Length`, `Cache-Control: public, max-age=31536000, immutable`
    - No range request support needed (images are small, not streamed progressively)

    **CoverArt component** at `src/lib/components/CoverArt.svelte`:
    - Svelte 5 with `$props()` runes
    - Props: `trackId: string`, `artPath: string | null`, `title: string`, `size?: 'sm' | 'md' | 'lg'` (default 'md')
    - Size classes: sm = `w-16 h-16`, md = `w-24 h-24 md:w-32 md:h-32`, lg = `w-full max-w-md aspect-square`
    - If artPath is truthy: render `<img>` with `src="{base}/api/tracks/{trackId}/art"` (import `base` from `$app/paths`), `alt="Cover art for {title}"`, `loading="lazy"`, `class` includes size + `rounded-lg object-cover`
    - If artPath is falsy: render a `<div>` placeholder with same size classes, `rounded-lg bg-zinc-800 flex items-center justify-center`, containing a music note character (Unicode &#9835;) in `text-zinc-600`
    - The lg size placeholder should use `text-4xl`, sm should use `text-lg`, md should use `text-2xl`
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` inside the Docker container (or locally if available) to confirm TypeScript compiles with zero errors. Verify both files exist on disk.
  </verify>
  <done>
    GET /api/tracks/{id}/art returns 200 with image/jpeg for tracks with cover art, 404 for tracks without. CoverArt.svelte renders an img tag for tracks with art and a placeholder div for tracks without.
  </done>
</task>

<task type="auto">
  <name>Task 2: TrackCard component, listing page rewrite, and error page</name>
  <files>
    src/lib/components/TrackCard.svelte
    src/routes/+page.server.ts
    src/routes/+page.svelte
    src/routes/+error.svelte
  </files>
  <action>
    **TrackCard component** at `src/lib/components/TrackCard.svelte`:
    - Svelte 5 with `$props()` runes
    - Import `CoverArt` from `./CoverArt.svelte`, `formatTime` from `$lib/utils/formatTime`, `base` from `$app/paths`
    - Props: `track` object with shape `{ id: string; slug: string; title: string; duration: number | null; playCount: number; artPath: string | null }`
    - Render as an `<a>` tag linking to `{base}/track/{track.slug}`
    - Layout: flex row with CoverArt (size="sm") on the left, track info on the right
    - Track info: title as `h2` (text-zinc-200, font-medium, truncate, hover:text-white), below it a row with duration (if not null, use formatTime) and play count (e.g., "{track.playCount} plays") in text-xs text-zinc-500
    - Card styling: `flex items-center gap-4 p-3 rounded-lg bg-zinc-900/50 hover:bg-zinc-800/70 transition-colors group`
    - Apply `group-hover:text-white` on the title for hover effect

    **Update +page.server.ts**:
    - Add `artPath`, `playCount`, `category`, and `createdAt` to the select query (keep existing id, title, slug, duration fields)
    - Remove `status` from select (we filter by status='ready' but don't need it in the response)
    - Add `desc(tracks.createdAt)` ordering (import `desc` from 'drizzle-orm')

    **Rewrite +page.svelte**:
    - Remove `WaveformPlayer` import entirely (per research pitfall #6 -- no waveform instances on listing)
    - Import `TrackCard` from `$lib/components/TrackCard.svelte`
    - Import `base` from `$app/paths`
    - Add `<svelte:head>` with `<title>wallybrain</title>` and a meta description
    - Page structure: `min-h-screen bg-zinc-950` container, `max-w-3xl mx-auto px-4 py-8`
    - Header: "wallybrain" as h1 (text-3xl font-bold text-white mb-2), and a subtitle "electronic music" as p (text-zinc-500 text-sm mb-8)
    - Track list: `space-y-3` div, iterate with `{#each data.tracks as track (track.id)}` rendering `<TrackCard {track} />`
    - Empty state: "No tracks yet." in text-zinc-500

    **Custom error page** at `src/routes/+error.svelte`:
    - Import `page` from `$app/state` and `base` from `$app/paths`
    - Centered full-height layout: `min-h-screen bg-zinc-950 flex items-center justify-center`
    - Show `page.status` as large heading (text-4xl font-bold text-zinc-300)
    - Show `page.error?.message` or "Something went wrong" as body text (text-zinc-500)
    - Link back to `{base}/` with text "Back to tracks" (text-violet-400 hover:text-violet-300)
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` for zero TypeScript errors. Rebuild Docker container with `docker compose -f /home/user/wallybrain-music/docker-compose.yml up -d --build`. Verify the listing page loads at localhost:8800/music/ using curl (check for "TrackCard" or "wallybrain" in response). Verify a request to a nonexistent slug (e.g., curl localhost:8800/music/track/nonexistent) returns a page with the error status.
  </verify>
  <done>
    Track listing page at /music shows cards with cover art, title, duration, and play count for all ready tracks ordered by newest first. No WaveformPlayer instances on the listing page. Invalid URLs display a styled error page with a back link.
  </done>
</task>

</tasks>

<verification>
1. `npx svelte-check --tsconfig ./tsconfig.json` reports 0 errors
2. Docker container builds and starts healthy
3. GET /music/ returns listing page with TrackCard layout (no waveform-player class in HTML)
4. GET /music/api/tracks/{id}/art returns 200 image/jpeg for a track with cover art
5. GET /music/api/tracks/{id}/art returns 404 for nonexistent track
6. GET /music/track/nonexistent returns error page (not a server crash)
</verification>

<success_criteria>
- Track listing displays all ready tracks as cards with cover art (or placeholder), title, duration, play count
- Cover art endpoint serves JPEG images with immutable cache headers
- No WaveformPlayer components mounted on the listing page
- Custom error page renders for 404s with dark theme styling
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-track-pages/04-01-SUMMARY.md`
</output>
