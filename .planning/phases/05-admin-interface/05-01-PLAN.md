---
phase: 05-admin-interface
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/routes/admin/+layout.svelte
  - src/routes/admin/+page.server.ts
  - src/routes/admin/+page.svelte
  - src/routes/admin/upload/+page.svelte
  - src/routes/api/tracks/[id]/status/+server.ts
autonomous: true

must_haves:
  truths:
    - "Admin can see a list of all tracks (including non-ready ones) with their processing status"
    - "Admin can drag and drop audio files onto an upload area and see them begin processing"
    - "Admin can click a browse button to select audio files as a fallback to drag-and-drop"
    - "Admin can see real-time processing status for each uploaded track updating every 2 seconds"
    - "Upload area supports multiple files dropped at once, each tracked independently"
  artifacts:
    - path: "src/routes/admin/+layout.svelte"
      provides: "Admin layout with nav header and back link"
      min_lines: 10
    - path: "src/routes/admin/+page.server.ts"
      provides: "Load function returning ALL tracks (all statuses) ordered by newest first"
      exports: ["load"]
    - path: "src/routes/admin/+page.svelte"
      provides: "Track management page showing all tracks with status badges and action links"
      min_lines: 30
    - path: "src/routes/admin/upload/+page.svelte"
      provides: "Drag-and-drop upload page with multi-file support and live status polling"
      min_lines: 60
    - path: "src/routes/api/tracks/[id]/status/+server.ts"
      provides: "GET endpoint returning track status and error message for polling"
      exports: ["GET"]
  key_links:
    - from: "src/routes/admin/upload/+page.svelte"
      to: "/api/upload"
      via: "fetch POST with FormData"
      pattern: "fetch.*api/upload"
    - from: "src/routes/admin/upload/+page.svelte"
      to: "/api/tracks/[id]/status"
      via: "$effect polling with setInterval"
      pattern: "api/tracks.*status"
    - from: "src/routes/admin/+page.server.ts"
      to: "tracks table"
      via: "drizzle query selecting all statuses"
      pattern: "from\\(tracks\\)"
    - from: "src/routes/admin/+page.svelte"
      to: "src/routes/admin/upload/+page.svelte"
      via: "navigation link"
      pattern: "admin/upload"
---

<objective>
Admin track list page, drag-and-drop upload page, and status polling API endpoint.

Purpose: Give the artist a protected web interface to upload audio files via drag-and-drop and monitor processing status in real time. This is the core admin workflow: upload tracks, watch them process, then edit metadata (Plan 02).

Output: Working admin pages at /music/admin (track list) and /music/admin/upload (drag-and-drop upload with live status), plus a status polling API endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-interface/05-RESEARCH.md

@src/routes/api/upload/+server.ts
@src/routes/+layout.svelte
@src/routes/+page.server.ts
@src/lib/server/db/schema.ts
@src/lib/server/db/client.ts
@src/lib/components/CoverArt.svelte
@src/app.css
@svelte.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Admin layout, track list page, and status polling endpoint</name>
  <files>
    src/routes/admin/+layout.svelte
    src/routes/admin/+page.server.ts
    src/routes/admin/+page.svelte
    src/routes/api/tracks/[id]/status/+server.ts
  </files>
  <action>
    **Status polling endpoint** at `src/routes/api/tracks/[id]/status/+server.ts`:
    - GET handler: look up track by `params.id` using Drizzle, selecting only `status` and `errorMessage` fields
    - If track not found, throw `error(404, 'Track not found')`
    - Return `json({ status, errorMessage })` with 200
    - Import `json, error` from `@sveltejs/kit`, `db` from `$lib/server/db/client`, `tracks` from `$lib/server/db/schema`, `eq` from `drizzle-orm`
    - Follow exact pattern of existing API endpoints (e.g., art/+server.ts)

    **Admin layout** at `src/routes/admin/+layout.svelte`:
    - Svelte 5 with `$props()` for children
    - Import `base` from `$app/paths`
    - Structure: `max-w-4xl mx-auto w-full px-4 py-6`
    - Top row: flex justify-between items-center mb-6
      - Left: `<a href="{base}/admin">` with text "admin" styled as `text-lg font-semibold text-zinc-300 hover:text-white`
      - Right: `<a href="{base}/">` with text "Back to site" styled as `text-sm text-zinc-500 hover:text-zinc-300`
    - Render `{@render children()}` below the header
    - NOTE: This layout is NESTED inside the root +layout.svelte (SvelteKit composes layouts). The root layout already provides the dark theme and min-h-screen flex-col structure. Do NOT duplicate those styles.

    **Admin track list page** at `src/routes/admin/+page.server.ts`:
    - Load function returns ALL tracks (no status filter), ordered by `desc(tracks.createdAt)`
    - Select fields: `id`, `title`, `slug`, `status`, `category`, `duration`, `artPath`, `errorMessage`, `createdAt`, `updatedAt`
    - Import `db` from `$lib/server/db/client`, `tracks` from `$lib/server/db/schema`, `desc` from `drizzle-orm`
    - Return `{ tracks: allTracks }`

    **Admin track list UI** at `src/routes/admin/+page.svelte`:
    - Import `base` from `$app/paths`, `CoverArt` from `$lib/components/CoverArt.svelte`
    - `let { data } = $props()`
    - Top section: flex justify-between items-center
      - `<h1>` "Track Management" as `text-2xl font-bold text-white`
      - Upload button: `<a href="{base}/admin/upload">` styled as a button with `bg-violet-600 hover:bg-violet-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors`
    - Track count: `<p>` showing "{data.tracks.length} tracks" in text-zinc-500 text-sm mb-4
    - Track list: iterate `{#each data.tracks as track (track.id)}`
      - Each item: `<a href="{base}/admin/tracks/{track.id}">` (link to edit page, Plan 02)
      - Layout: flex row, `items-center gap-4 p-3 rounded-lg bg-zinc-900/50 hover:bg-zinc-800/70 transition-colors`
      - Left: `<CoverArt trackId={track.id} artPath={track.artPath} title={track.title} size="sm" />`
      - Middle (flex-1): title as `text-zinc-200 font-medium truncate`, category badge as `text-xs uppercase tracking-wider text-zinc-500`
      - Right: Status badge using conditional colors:
        - `ready`: `bg-emerald-500/20 text-emerald-400`
        - `processing`: `bg-amber-500/20 text-amber-400`
        - `pending`: `bg-zinc-700/50 text-zinc-400`
        - `failed`: `bg-red-500/20 text-red-400`
      - Badge: `px-2 py-0.5 rounded text-xs font-medium`
      - If status is `failed` and errorMessage exists, show it below the title in `text-xs text-red-400/70 truncate`
    - Empty state: "No tracks uploaded yet." with a link to the upload page
    - Use `space-y-2` for the track list container
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` in the project root (or inside Docker container) for zero TypeScript errors. Rebuild Docker container with `docker compose -f /home/user/wallybrain-music/docker-compose.yml up -d --build`. Verify:
    1. `curl -s http://localhost:8800/music/admin/ | head -50` returns HTML containing "Track Management"
    2. `curl -s http://localhost:8800/music/api/tracks/nonexistent/status` returns 404
  </verify>
  <done>
    Admin track list page at /music/admin shows all tracks with status badges and links. Status API endpoint returns track status JSON. Admin layout provides navigation header with back-to-site link.
  </done>
</task>

<task type="auto">
  <name>Task 2: Drag-and-drop upload page with multi-file support and live status polling</name>
  <files>
    src/routes/admin/upload/+page.svelte
  </files>
  <action>
    **Upload page** at `src/routes/admin/upload/+page.svelte`:
    - Svelte 5 component using `$state` and `$effect` runes
    - Import `base` from `$app/paths`

    **State:**
    - `isDragging: boolean = $state(false)` -- visual feedback for drag hover
    - `uploads: Array<{ file: File; trackId: string | null; status: 'uploading' | 'pending' | 'processing' | 'ready' | 'failed'; error: string | null }> = $state([])`
    - `fileInput: HTMLInputElement` -- bound reference to hidden file input

    **Drop zone:**
    - `<div>` with `role="button"` and `tabindex="0"` for accessibility
    - Event attributes (Svelte 5 style, NOT on:directive):
      - `ondrop={handleDrop}` -- `e.preventDefault()`, `isDragging = false`, pass `e.dataTransfer.files` to `handleFiles()`
      - `ondragover={handleDragOver}` -- `e.preventDefault()`, `isDragging = true`
      - `ondragleave={handleDragLeave}` -- `isDragging = false`
    - Styling: `border-2 border-dashed rounded-lg p-12 text-center transition-colors`
      - When dragging: `border-violet-500 bg-violet-500/10`
      - Default: `border-zinc-700 hover:border-zinc-500`
    - Content: "Drag audio files here or" paragraph (text-zinc-400), then a button "browse files" (text-violet-400 hover:text-violet-300 underline) that calls `fileInput.click()`
    - Hidden `<input bind:this={fileInput} type="file" accept="audio/*" multiple onchange={handleFileSelect} class="hidden" />`

    **handleFiles(fileList: FileList):**
    - Iterate over each file in the FileList
    - For each file, create an upload entry with status 'uploading' and push to `uploads` array
    - POST to `${base}/api/upload` with FormData containing `audio` field (the file)
    - Do NOT set Content-Type header manually (let browser set multipart boundary)
    - On success: set `entry.trackId = data.trackId`, `entry.status = 'pending'`
    - On error: set `entry.status = 'failed'`, `entry.error = message`
    - Upload files sequentially (not in parallel) to avoid overwhelming the server

    **handleFileSelect(e: Event):**
    - Get files from `(e.currentTarget as HTMLInputElement).files`
    - Pass to `handleFiles()` if files exist

    **Status polling via $effect:**
    - Filter uploads array for entries with a `trackId` AND status is 'pending' or 'processing'
    - If no active entries, do nothing (return early)
    - Set up `setInterval` at 2000ms
    - For each active upload, fetch `${base}/api/tracks/${upload.trackId}/status`
    - Update `upload.status` and `upload.error` (from `data.errorMessage`) on each poll
    - Return cleanup function: `() => clearInterval(interval)`
    - The $effect tracks the `uploads` array reactively, so it re-runs when statuses change (stopping polling when all reach terminal state)

    **Upload list display:**
    - Below the drop zone, show `uploads` list if not empty
    - Each entry: flex row with file name (text-zinc-300, truncate), status badge (same color scheme as track list page), and error message if failed
    - Status 'uploading': show "Uploading..." with a subtle pulse animation (`animate-pulse`)
    - Status 'ready': show a link to edit the track `{base}/admin/tracks/{upload.trackId}` as "Edit metadata" (text-violet-400)
    - Container: `mt-8 space-y-3`

    **Page header:**
    - `<svelte:head><title>Upload - wallybrain admin</title></svelte:head>`
    - Heading: "Upload Tracks" as h1, text-2xl font-bold text-white mb-6
    - Below heading, small text: "Supported formats: MP3, WAV, FLAC, OGG, AIFF" in text-zinc-500 text-sm mb-4
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` for zero TypeScript errors. Rebuild Docker container with `docker compose -f /home/user/wallybrain-music/docker-compose.yml up -d --build`. Verify:
    1. `curl -s http://localhost:8800/music/admin/upload | head -50` returns HTML containing "Upload Tracks" and "Drag audio files"
    2. Test actual upload via curl: `curl -s -F "audio=@/path/to/test.mp3" http://localhost:8800/music/api/upload` returns 201 with trackId (existing endpoint still works)
  </verify>
  <done>
    Upload page at /music/admin/upload shows a drag-and-drop zone, accepts multiple files, uploads each to the existing /api/upload endpoint, and polls for processing status every 2 seconds. Each upload shows its current status with visual badges. Completed uploads offer a link to edit metadata.
  </done>
</task>

</tasks>

<verification>
1. `npx svelte-check --tsconfig ./tsconfig.json` reports 0 errors
2. Docker container builds and starts healthy
3. GET /music/admin/ returns track list page with all tracks and status badges
4. GET /music/admin/upload returns upload page with drag-and-drop zone
5. GET /music/api/tracks/{id}/status returns JSON with status field
6. GET /music/api/tracks/nonexistent/status returns 404
7. The admin layout provides navigation between track list and upload pages
</verification>

<success_criteria>
- Admin track list page displays all tracks regardless of status, with colored status badges
- Upload page has a functional drag-and-drop zone with browse-files fallback
- Multi-file upload works by iterating FileList and calling existing /api/upload endpoint per file
- Status polling via $effect + setInterval updates every 2 seconds until terminal state
- Polling cleanup happens on unmount (clearInterval in $effect return)
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-interface/05-01-SUMMARY.md`
</output>
