---
phase: 05-admin-interface
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/routes/admin/tracks/[id]/+page.server.ts
  - src/routes/admin/tracks/[id]/+page.svelte
  - /home/user/v1be-code-server/Caddyfile
autonomous: false

must_haves:
  truths:
    - "Admin can edit track metadata (title, description, category) and save changes"
    - "Admin can edit tags as comma-separated text that gets normalized and saved"
    - "Admin can upload custom cover art that replaces existing art"
    - "Admin can edit the track slug for nicer URLs with uniqueness validation"
    - "The admin interface is only accessible after authenticating through Authelia 2FA"
    - "Public music routes (/music, /music/track/*) remain accessible without authentication"
  artifacts:
    - path: "src/routes/admin/tracks/[id]/+page.server.ts"
      provides: "Load function for track + tags, form actions for metadata update and cover art upload"
      exports: ["load", "actions"]
    - path: "src/routes/admin/tracks/[id]/+page.svelte"
      provides: "Metadata edit form with title, description, category, tags, slug, and cover art upload"
      min_lines: 60
    - path: "/home/user/v1be-code-server/Caddyfile"
      provides: "Caddy routing with @admin matcher before @music, forward_auth for admin paths"
      contains: "@admin path /music/admin"
  key_links:
    - from: "src/routes/admin/tracks/[id]/+page.server.ts"
      to: "tracks table"
      via: "drizzle update with form data"
      pattern: "db\\.update\\(tracks\\)"
    - from: "src/routes/admin/tracks/[id]/+page.server.ts"
      to: "tags and trackTags tables"
      via: "drizzle upsert for tag management"
      pattern: "db\\.insert\\(tags\\)"
    - from: "src/routes/admin/tracks/[id]/+page.server.ts"
      to: "$lib/server/processors/artwork.ts"
      via: "extractAndResizeArt for cover art upload"
      pattern: "extractAndResizeArt"
    - from: "src/routes/admin/tracks/[id]/+page.svelte"
      to: "src/routes/admin/tracks/[id]/+page.server.ts"
      via: "SvelteKit form action with use:enhance"
      pattern: "use:enhance"
    - from: "/home/user/v1be-code-server/Caddyfile"
      to: "authelia:9091"
      via: "forward_auth subrequest for @admin paths"
      pattern: "forward_auth authelia"
---

<objective>
Track metadata edit page and Caddy forward_auth protection for admin routes.

Purpose: Complete the admin interface by adding the metadata editing workflow (title, description, cover art, tags, category, slug) and securing all admin routes behind Authelia 2FA. After this plan, the full admin workflow is functional: upload tracks, watch them process, edit their metadata, all behind authentication.

Output: Working track edit page at /music/admin/tracks/[id] with form actions for metadata and cover art, plus Caddyfile updated to protect /music/admin/* with forward_auth.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-admin-interface/05-RESEARCH.md
@.planning/phases/05-admin-interface/05-01-SUMMARY.md

@src/lib/server/db/schema.ts
@src/lib/server/db/client.ts
@src/lib/server/processors/artwork.ts
@src/lib/components/CoverArt.svelte
@src/routes/admin/+layout.svelte
@/home/user/v1be-code-server/Caddyfile
@svelte.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track metadata edit page with form actions</name>
  <files>
    src/routes/admin/tracks/[id]/+page.server.ts
    src/routes/admin/tracks/[id]/+page.svelte
  </files>
  <action>
    **Server load + actions** at `src/routes/admin/tracks/[id]/+page.server.ts`:
    - Import: `db` from `$lib/server/db/client`, `tracks, tags, trackTags` from `$lib/server/db/schema`, `eq` from `drizzle-orm`, `fail, error` from `@sveltejs/kit`, `extractAndResizeArt` from `$lib/server/processors/artwork`, `existsSync, mkdirSync` from `node:fs`
    - Type imports: `Actions, PageServerLoad` from `./$types`

    **Load function:**
    - Look up track by `params.id` using `db.select().from(tracks).where(eq(tracks.id, params.id)).get()`
    - If not found, throw `error(404, 'Track not found')`
    - Query tags: `db.select({ name: tags.name }).from(trackTags).innerJoin(tags, eq(trackTags.tagId, tags.id)).where(eq(trackTags.trackId, params.id)).all()`
    - Return `{ track, tags: trackTagRows.map(t => t.name) }`

    **Actions** (use `satisfies Actions`):
    - `update` action:
      - Parse formData: `title`, `description`, `category`, `slug`, `tags` (all as string), `coverArt` (as File)
      - Validate: title is required and non-empty (return `fail(400, { error: 'Title is required' })`)
      - Validate slug: required, non-empty, transform to lowercase, replace non-alphanumeric with hyphens, trim leading/trailing hyphens, limit to 100 chars. Check uniqueness: query for existing track with same slug AND different id. If collision, return `fail(400, { error: 'Slug already in use by another track' })`
      - Update track: `db.update(tracks).set({ title: title.trim(), description: description?.trim() || null, category: category || 'track', slug: validatedSlug, updatedAt: new Date().toISOString() }).where(eq(tracks.id, params.id)).run()`
      - Handle tags: clear existing trackTags for this track id, parse comma-separated input (split by comma, trim, lowercase, filter empty, deduplicate), for each tag name: insert into tags table with `onConflictDoNothing()`, query back to get tag id, insert into trackTags with `{ trackId: params.id, tagId: tag.id }`
      - Handle cover art: if `coverArt` is a File and `coverArt.size > 0`:
        - `const artBuffer = Buffer.from(await coverArt.arrayBuffer())`
        - `const artDir = '/data/art'`; ensure dir exists with `mkdirSync(artDir, { recursive: true })`
        - `const artPath = '/data/art/${params.id}.jpg'`
        - Call `await extractAndResizeArt(artBuffer, artPath)` (reuses existing sharp-based function)
        - Update track: `db.update(tracks).set({ artPath, updatedAt: new Date().toISOString() }).where(eq(tracks.id, params.id)).run()`
      - Return `{ success: true }`

    **Edit page UI** at `src/routes/admin/tracks/[id]/+page.svelte`:
    - Svelte 5 with `$props()` runes
    - Import `enhance` from `$app/forms`, `base` from `$app/paths`, `CoverArt` from `$lib/components/CoverArt.svelte`
    - `let { data, form } = $props()`
    - `let track = $derived(data.track)`, `let tagString = $state(data.tags.join(', '))`

    - `<svelte:head><title>Edit: {track.title} - wallybrain admin</title></svelte:head>`

    - Back link: `<a href="{base}/admin">` with text "Back to tracks" (text-zinc-500 hover:text-zinc-300 text-sm mb-6 inline-block)

    - Status indicator at top: show current `track.status` with the same colored badge style as the track list (ready=emerald, processing=amber, pending=zinc, failed=red)

    - Form: `<form method="POST" action="?/update" use:enhance enctype="multipart/form-data">`
    - Show success message if `form?.success`: green text "Changes saved" (text-emerald-400 text-sm mb-4)
    - Show error if `form?.error`: red text (text-red-400 text-sm mb-4)

    - Form fields (each in a `<div class="space-y-1">` with `<label>` in `text-sm text-zinc-400`):
      1. **Title** (required): `<input type="text" name="title" value={track.title} required class="w-full bg-zinc-800 border border-zinc-700 rounded-lg px-3 py-2 text-zinc-200 focus:border-violet-500 focus:outline-none" />`
      2. **Slug**: `<input type="text" name="slug" value={track.slug} required>` with same styling as title. Helper text below: "URL: /music/track/{slug}" in text-xs text-zinc-600
      3. **Description**: `<textarea name="description" rows="4" class="[same styling as input] resize-y">{track.description || ''}</textarea>`
      4. **Category**: `<select name="category" class="[same bg/border styling]">` with options: track, set, experiment, export. Set `selected` based on `track.category`
      5. **Tags**: `<input type="text" name="tags" value={tagString}>` with same styling. Helper: "Comma-separated, e.g.: ambient, techno, modular" in text-xs text-zinc-600
      6. **Cover Art**: Show current art with `<CoverArt trackId={track.id} artPath={track.artPath} title={track.title} size="md" />` above the file input. `<input type="file" name="coverArt" accept="image/*" class="text-sm text-zinc-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:bg-zinc-800 file:text-zinc-300 hover:file:bg-zinc-700" />`

    - Submit button: `<button type="submit" class="bg-violet-600 hover:bg-violet-500 text-white px-6 py-2 rounded-lg font-medium transition-colors">Save Changes</button>`

    - Form fields container: `space-y-5` with the submit button in a `mt-6 flex justify-end`

    - Below the form, if track has a slug and status is 'ready', show a "View public page" link to `{base}/track/{track.slug}` in text-violet-400

    **Important Svelte 5 notes:**
    - Use `value={track.title}` not `bind:value` for form fields submitted via form actions (the server response resets the data)
    - Use `onchange` not `on:change` for any event handlers
    - The `use:enhance` directive progressively enhances the form (submits without full page reload)
    - `enctype="multipart/form-data"` is REQUIRED on the form element for the cover art file upload to work
  </action>
  <verify>
    Run `npx svelte-check --tsconfig ./tsconfig.json` for zero TypeScript errors. Rebuild Docker container with `docker compose -f /home/user/wallybrain-music/docker-compose.yml up -d --build`. If there are tracks in the database, verify:
    1. `curl -s http://localhost:8800/music/admin/tracks/{TRACK_ID} | head -50` returns HTML containing "Save Changes"
    2. Test form submission: `curl -s -X POST -F "title=Test Title" -F "slug=test-slug" -F "description=Test" -F "category=track" -F "tags=ambient, techno" http://localhost:8800/music/admin/tracks/{TRACK_ID}?/update` returns successfully
  </verify>
  <done>
    Track edit page at /music/admin/tracks/[id] shows a metadata form with title, slug, description, category, tags, and cover art upload. Form submission updates the database via SvelteKit form actions. Tags are parsed as comma-separated, normalized, and upserted. Cover art is resized via sharp and saved. Validation errors display inline.
  </done>
</task>

<task type="auto">
  <name>Task 2: Caddy forward_auth configuration for admin route protection</name>
  <files>
    /home/user/v1be-code-server/Caddyfile
  </files>
  <action>
    **Modify the Caddyfile** at `/home/user/v1be-code-server/Caddyfile`:

    The current Caddyfile has two handle blocks under `{$DOMAIN}`:
    1. `@music path /music /music/*` -> `reverse_proxy wallybrain-music:8800` (public, no auth)
    2. Default `handle` -> `forward_auth authelia:9091` + `reverse_proxy code-server:8080`

    Add a NEW `@admin` handle block BEFORE the existing `@music` block. The order matters: Caddy evaluates named matchers by specificity, but explicit ordering ensures the more specific `/music/admin*` path matches first.

    Updated structure:
    ```
    {$DOMAIN} {
        # Admin music routes: require Authelia 2FA
        @admin path /music/admin /music/admin/*
        handle @admin {
            forward_auth authelia:9091 {
                uri /api/authz/forward-auth
                copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
            }
            reverse_proxy wallybrain-music:8800
        }

        # Public music routes: no auth required
        @music path /music /music/*
        handle @music {
            reverse_proxy wallybrain-music:8800
        }

        # Everything else: code-server behind Authelia
        handle {
            forward_auth authelia:9091 {
                uri /api/authz/forward-auth
                copy_headers Remote-User Remote-Groups Remote-Email Remote-Name
            }
            reverse_proxy code-server:8080
        }
    }
    ```

    Keep the existing `auth.{$DOMAIN}` block at the top unchanged.

    **Do NOT modify Authelia's configuration** (configuration.yml, access_control rules). Per research: Caddy only sends forward_auth subrequests for paths handled by the `@admin` block. Public music paths handled by `@music` never reach Authelia. The existing blanket `two_factor` policy in Authelia already covers any request that reaches it.

    **After writing the Caddyfile**, restart the Caddy container to pick up changes:
    ```bash
    docker restart caddy
    ```
    Note: Caddy requires container restart (not just `caddy reload`) for bind-mounted config changes per Phase 1 decision.
  </action>
  <verify>
    After restarting Caddy:
    1. Public routes remain accessible: `curl -s -o /dev/null -w "%{http_code}" https://wallyblanchard.com/music/` returns 200
    2. Admin routes are protected: `curl -s -o /dev/null -w "%{http_code}" https://wallyblanchard.com/music/admin/` returns 302 (redirect to Authelia login portal) or 401
    3. Check Caddy logs for any config errors: `docker logs caddy --tail 20`
  </verify>
  <done>
    Admin routes at /music/admin/* require Authelia 2FA authentication. Public music routes at /music/* remain accessible without authentication. Caddy correctly routes admin paths through forward_auth before proxying to the SvelteKit app.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete admin interface: track list, drag-and-drop upload with live status polling, metadata editor (title, slug, description, category, tags, cover art), and Authelia 2FA protection for all admin routes. Public music pages remain accessible without authentication.
  </what-built>
  <how-to-verify>
    1. Visit https://wallyblanchard.com/music/ -- should load without authentication (public)
    2. Visit https://wallyblanchard.com/music/admin/ -- should redirect to Authelia login
    3. Authenticate through Authelia 2FA
    4. After login, /music/admin/ should show the track management page with all tracks and status badges
    5. Click "Upload" -- drag an audio file onto the drop zone (or click browse)
    6. Watch the status update from "uploading" to "pending" to "processing" to "ready"
    7. Click "Edit metadata" on a completed upload (or any track in the list)
    8. Change the title, add some tags (comma-separated), optionally upload cover art
    9. Click "Save Changes" -- confirm "Changes saved" message appears
    10. Visit the public track page to verify metadata changes are reflected
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `npx svelte-check --tsconfig ./tsconfig.json` reports 0 errors
2. Docker container builds and starts healthy
3. GET /music/admin/tracks/{id} returns metadata edit form
4. POST to /music/admin/tracks/{id}?/update saves metadata changes
5. Cover art upload via the edit form produces resized JPEG
6. Tags are stored normalized (lowercase, trimmed, deduplicated)
7. Slug uniqueness is validated before save
8. Caddy @admin matcher protects /music/admin/* with forward_auth
9. Public /music/* routes remain unauthenticated
10. Caddy container restarts without errors
</verification>

<success_criteria>
- Track edit page allows editing title, slug, description, category, tags, and cover art
- Form actions use SvelteKit's use:enhance for progressive enhancement
- Cover art upload reuses existing extractAndResizeArt function from processing pipeline
- Tag management handles comma-separated input with normalization and upsert
- Slug editing validates uniqueness against other tracks
- Caddy forward_auth blocks unauthenticated access to /music/admin/*
- Public music routes are unaffected by auth changes
- Human verification confirms full upload-process-edit workflow
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-interface/05-02-SUMMARY.md`
</output>
