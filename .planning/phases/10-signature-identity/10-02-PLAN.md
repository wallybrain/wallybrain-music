---
phase: 10-signature-identity
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/routes/+page.server.ts
  - src/routes/+page.svelte
  - src/routes/track/[slug]/+page.server.ts
  - src/routes/track/[slug]/+page.svelte
  - src/lib/components/CoverArt.svelte
  - src/lib/components/TrackCard.svelte
autonomous: true

must_haves:
  truths:
    - "Opening a track detail page shows an ambient color tint derived from that track's cover art"
    - "Cover art on the track detail page has an ambient glow matching the dominant color"
    - "The currently-playing track shows an animated equalizer bar indicator in the track listing"
    - "Track cards appear with a staggered entrance animation when the listing loads"
    - "Each track's detail page looks visually unique based on its cover art colors"
    - "Tracks without cover art gracefully fall back to the accent color for ambient effects"
  artifacts:
    - path: "src/routes/track/[slug]/+page.svelte"
      provides: "Ambient background tint and glow CSS custom properties from dominantColor"
      contains: "--track-tint"
    - path: "src/routes/track/[slug]/+page.server.ts"
      provides: "dominantColor included in track data load"
      contains: "dominantColor"
    - path: "src/lib/components/CoverArt.svelte"
      provides: "Ambient glow box-shadow on lg size cover art when dominantColor provided"
      contains: "box-shadow"
    - path: "src/lib/components/TrackCard.svelte"
      provides: "EqIndicator shown when track is currently playing"
      contains: "EqIndicator"
    - path: "src/routes/+page.svelte"
      provides: "Staggered fly entrance animation on track cards"
      contains: "in:fly"
    - path: "src/routes/+page.server.ts"
      provides: "dominantColor included in track listing query"
      contains: "dominantColor"
  key_links:
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "src/lib/utils/colorUtils.ts"
      via: "import rgbHexToOklch, formatOklch"
      pattern: "import.*colorUtils"
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "src/routes/track/[slug]/+page.server.ts"
      via: "data.track.dominantColor from server load"
      pattern: "track\\.dominantColor"
    - from: "src/lib/components/TrackCard.svelte"
      to: "src/lib/components/EqIndicator.svelte"
      via: "import and conditional render when isPlaying"
      pattern: "import.*EqIndicator"
    - from: "src/routes/+page.svelte"
      to: "svelte/transition"
      via: "import fly for staggered entrance"
      pattern: "import.*fly.*svelte/transition"
    - from: "src/lib/components/CoverArt.svelte"
      to: "dominantColor prop"
      via: "box-shadow style binding"
      pattern: "dominantColor"
---

<objective>
Wire dominantColor into the frontend: ambient background tint and cover art glow on track detail pages, equalizer indicator on playing tracks, and staggered entrance animations on track listings.

Purpose: Delivers the four visible SIGN requirements -- each track detail page feels visually unique, playing tracks are visually distinguished, and the track listing has a polished reveal animation.
Output: All four signature identity features working end-to-end.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-signature-identity/10-RESEARCH.md
@.planning/phases/10-signature-identity/10-01-SUMMARY.md
@src/routes/+page.server.ts
@src/routes/+page.svelte
@src/routes/track/[slug]/+page.server.ts
@src/routes/track/[slug]/+page.svelte
@src/lib/components/CoverArt.svelte
@src/lib/components/TrackCard.svelte
@src/lib/components/EqIndicator.svelte
@src/lib/utils/colorUtils.ts
@src/app.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track detail ambient tint, cover art glow, and server data wiring</name>
  <files>src/routes/track/[slug]/+page.server.ts, src/routes/track/[slug]/+page.svelte, src/lib/components/CoverArt.svelte</files>
  <action>
1. **Wire dominantColor into track detail data** (`src/routes/track/[slug]/+page.server.ts`):
   The current `db.select().from(tracks)` already selects all columns (no explicit column list), so `track.dominantColor` is already included in the returned data. No changes needed here -- verify this by checking the existing select call uses `.select()` (select-all), not `.select({ ... })`.

   If it uses `.select({ ... })` with explicit columns, add `dominantColor: tracks.dominantColor` to the selection.

2. **Add ambient background tint** to `src/routes/track/[slug]/+page.svelte`:
   - Import colorUtils at the top of the script:
     ```typescript
     import { rgbHexToOklch, formatOklch } from '$lib/utils/colorUtils';
     ```
   - Add a derived style computation after the existing `track` derived:
     ```typescript
     let ambientStyle = $derived.by(() => {
       if (!track.dominantColor) return '';
       const oklch = rgbHexToOklch(track.dominantColor);
       const tintL = Math.max(0.15, oklch.l * 0.35);
       const tintC = oklch.c * 0.4;
       return `--track-tint: oklch(${tintL.toFixed(3)} ${tintC.toFixed(3)} ${oklch.h.toFixed(1)} / 0.15); --track-glow: ${track.dominantColor};`;
     });
     ```
   - On the outermost `<div class="max-w-3xl mx-auto px-4 py-8">`, add `relative` to the class list and add `style={ambientStyle}`:
     ```svelte
     <div class="relative max-w-3xl mx-auto px-4 py-8" style={ambientStyle}>
     ```
   - Immediately inside this div (after the opening tag, BEFORE the "Back to tracks" link), add the ambient tint overlay:
     ```svelte
     {#if track.dominantColor}
       <div class="absolute inset-0 -z-10 rounded-xl bg-[var(--track-tint)]"
         style="mask-image: radial-gradient(ellipse at top, black 0%, transparent 70%); -webkit-mask-image: radial-gradient(ellipse at top, black 0%, transparent 70%);">
       </div>
     {/if}
     ```
   CRITICAL: The ambient tint div uses `absolute` positioning and `-z-10`. It is a SIBLING of the content, NOT an ancestor of WaveformPlayer. No `transform` or `filter` is applied to it. This is safe for waveform drag-to-seek.

3. **Add ambient glow to CoverArt.svelte** (`src/lib/components/CoverArt.svelte`):
   - Add `dominantColor` as an optional prop:
     ```typescript
     let { trackId, artPath, title, size = 'md', dominantColor = null }: {
       trackId: string;
       artPath: string | null;
       title: string;
       size?: 'sm' | 'md' | 'lg';
       dominantColor?: string | null;
     } = $props();
     ```
   - Add a derived glow style:
     ```typescript
     let glowStyle = $derived(
       dominantColor && size === 'lg'
         ? `box-shadow: 0 0 40px ${dominantColor}66, 0 0 80px ${dominantColor}33, 0 4px 16px rgba(0,0,0,0.4);`
         : ''
     );
     ```
   - On the `<img>` element, add `style={glowStyle}`. Keep the existing `shadow-lg shadow-black/40` classes as they are -- when `glowStyle` is set (lg + dominantColor), the inline box-shadow will override the Tailwind shadow classes. When not set, the Tailwind shadow remains.
   - On the placeholder `<div>`, no glow is needed (no cover art = no dominant color to glow with).

4. **Pass dominantColor to CoverArt** in `src/routes/track/[slug]/+page.svelte`:
   Update the CoverArt usage to pass the new prop:
   ```svelte
   <CoverArt trackId={track.id} artPath={track.artPath} title={track.title} size="lg" dominantColor={track.dominantColor} />
   ```

   The hex color with alpha suffix approach (e.g., `#7c3aed66`) is used for box-shadow glow because it avoids OKLCH rendering edge cases in box-shadow across browsers (see Research pitfall 6).
  </action>
  <verify>
    1. `npm run build` succeeds.
    2. `npm run check` passes.
    3. Confirm `track.dominantColor` is available in the page data (check +page.server.ts select).
    4. Confirm the ambient tint div does NOT wrap or ancestor the WaveformPlayer -- it must be a sibling with `-z-10`.
    5. Confirm CoverArt.svelte accepts `dominantColor` prop and applies glow only at `size === 'lg'`.
  </verify>
  <done>
    Track detail page shows ambient color tint fading from top when dominantColor exists (SIGN-01). Cover art at lg size shows multi-layer ambient glow matching dominant color (SIGN-04). Tracks without cover art gracefully show no ambient effects. No waveform breakage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Equalizer indicator on playing tracks and staggered entrance animations</name>
  <files>src/lib/components/TrackCard.svelte, src/routes/+page.svelte, src/routes/+page.server.ts</files>
  <action>
1. **Add dominantColor to track listing query** (`src/routes/+page.server.ts`):
   The current query uses `.select({ ... })` with explicit columns. Add `dominantColor` to the selection:
   ```typescript
   dominantColor: tracks.dominantColor,
   ```
   Add this after the existing `category: tracks.category` line in the select object.

2. **Add EqIndicator to TrackCard** (`src/lib/components/TrackCard.svelte`):
   - Import the component:
     ```typescript
     import EqIndicator from './EqIndicator.svelte';
     ```
   - The TrackCard already has `isPlaying` and `isCurrentTrack` derived states. Replace the existing play/pause button section with one that includes the equalizer. Currently the card has three states: isPlaying, isCurrentTrack (paused), else (not playing). When `isPlaying` is true, show the EqIndicator alongside (or replacing) the pause button.

   - In the `{#if isPlaying}` block, add the EqIndicator BEFORE the pause button, inside the same container area. Wrap both in a flex container:
     ```svelte
     {#if isPlaying}
       <div class="shrink-0 flex items-center gap-2">
         <EqIndicator />
         <button
           onclick={handleToggle}
           class="w-8 h-8 rounded-full bg-accent hover:bg-accent-hover text-text-primary flex items-center justify-center text-xs transition-opacity md:opacity-0 md:group-hover:opacity-100"
           aria-label="Pause"
         >&#9646;&#9646;</button>
       </div>
     ```
   - The `{:else if isCurrentTrack}` and `{:else}` blocks remain unchanged.

   - The EqIndicator is placed inside TrackCard which does NOT contain any WaveformPlayer. The `hover:scale-[1.01]` on TrackCard is safe because TrackCard has no waveform children.

3. **Add staggered entrance animation** to `src/routes/+page.svelte`:
   - Import fly transition and easing:
     ```typescript
     import { fly } from 'svelte/transition';
     import { cubicOut } from 'svelte/easing';
     ```
   - Wrap each TrackCard in a `<div>` with the fly entrance transition. Change the `{#each}` block from:
     ```svelte
     {#each data.tracks as track, i (track.id)}
       <TrackCard {track} allTracks={queueTracks} index={i} />
     {/each}
     ```
   To:
     ```svelte
     {#each data.tracks as track, i (track.id)}
       <div in:fly={{ y: 15, duration: 250, delay: Math.min(i * 60, 600), easing: cubicOut }}>
         <TrackCard {track} allTracks={queueTracks} index={i} />
       </div>
     {/each}
     ```

   Key tuning: `y: 15` (subtle upward slide), `duration: 250` (fast), `delay: Math.min(i * 60, 600)` (60ms stagger, capped at 600ms total so lists of 10+ tracks don't take forever). Using `in:` (not `transition:`) means only entrance is animated -- navigation away is instant.

   NOTE: The stagger will replay on back-navigation. Per the research, this is acceptable if kept subtle (15px, 250ms). If it feels annoying in testing, a module-level flag can be added later to skip on re-mount, but start without it.

4. **Update TrackCard type** to include `dominantColor` (for future use and type safety):
   In TrackCard's props type, add `dominantColor` to the track type:
   ```typescript
   let { track, allTracks, index }: {
     track: {
       id: string;
       slug: string;
       title: string;
       duration: number | null;
       playCount: number;
       artPath: string | null;
       category: string;
       tags: string[];
       dominantColor?: string | null;
     };
     // ... rest unchanged
   } = $props();
   ```
  </action>
  <verify>
    1. `npm run build` succeeds.
    2. `npm run check` passes.
    3. Confirm `EqIndicator` is imported and rendered conditionally in TrackCard when `isPlaying`.
    4. Confirm `in:fly` with stagger delay is applied in the track listing `{#each}` block.
    5. Confirm `dominantColor` is included in the +page.server.ts track listing query.
  </verify>
  <done>
    Currently-playing track shows animated equalizer bars next to the pause button (SIGN-02). Track listing cards appear with staggered fly entrance animation (SIGN-03). dominantColor is available in track listing data for future use. Build and type checks pass.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. `npm run check` passes TypeScript verification
3. Track detail page: ambient tint visible (colored radial gradient at top of page)
4. Track detail page: cover art has multi-layer glow shadow matching cover colors
5. Track listing: currently-playing track shows animated equalizer bars
6. Track listing: cards animate in with staggered entrance on page load
7. No waveform drag-to-seek breakage (ambient tint div is sibling, not ancestor, of waveform)
8. Tracks without cover art show no ambient effects (graceful fallback)
</verification>

<success_criteria>
- Track detail pages show ambient color tint from cover art's dominant color (SIGN-01)
- Currently-playing track has animated equalizer indicator in track listing (SIGN-02)
- Track cards use staggered fly entrance animation on load (SIGN-03)
- Cover art on track detail page has ambient glow matching dominant color (SIGN-04)
- All effects gracefully handle tracks without cover art
- No waveform/player functionality broken
- Build and type checks pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-signature-identity/10-02-SUMMARY.md`
</output>
