---
phase: 07-persistent-player-and-queue
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/components/TrackCard.svelte
  - src/routes/+page.svelte
  - src/routes/track/[slug]/+page.svelte
autonomous: true

must_haves:
  truths:
    - "Clicking play on a track card in the listing starts playback in the persistent player and populates the queue with all visible tracks"
    - "Clicking play on the track detail page starts playback in the persistent player with that single track"
    - "When the current track ends, the next track in the queue automatically begins playing without user interaction"
    - "Navigating from the listing page to a track detail page while audio is playing does NOT interrupt playback"
    - "On the track detail page, when the persistent player is playing that same track, the page-level WaveformPlayer is hidden and replaced with a Now Playing indicator"
    - "When the persistent player is playing a different track, the track detail page shows its normal WaveformPlayer"
  artifacts:
    - path: "src/lib/components/TrackCard.svelte"
      provides: "Play button that dispatches to global playerState"
      contains: "playerState.play"
    - path: "src/routes/+page.svelte"
      provides: "Passes allTracks and index to TrackCard for queue population"
      contains: "allTracks"
    - path: "src/routes/track/[slug]/+page.svelte"
      provides: "Play button dispatching to persistent player, coexistence handling with WaveformPlayer"
      contains: "playerState"
  key_links:
    - from: "src/lib/components/TrackCard.svelte"
      to: "src/lib/stores/playerState.svelte.ts"
      via: "import playerState, call play() on click"
      pattern: "playerState\\.play"
    - from: "src/routes/+page.svelte"
      to: "src/lib/components/TrackCard.svelte"
      via: "passes allTracks array and index prop"
      pattern: "allTracks"
    - from: "src/routes/track/[slug]/+page.svelte"
      to: "src/lib/stores/playerState.svelte.ts"
      via: "checks playerState.currentTrack?.id to conditionally show/hide WaveformPlayer"
      pattern: "playerState\\.currentTrack"
---

<objective>
Wire the existing track listing and track detail pages to dispatch playback through the global player state, populating the queue from visible tracks. Handle coexistence between the persistent player and the page-level WaveformPlayer on the track detail page. Enable continuous auto-play queue progression when tracks end.

Purpose: This connects the persistent player (built in Plan 01) to the actual user interactions -- clicking play on track cards and track detail pages. Without this wiring, the persistent player exists but has no way to receive tracks to play.

Output: Modified TrackCard.svelte (play button), +page.svelte (queue data), track/[slug]/+page.svelte (play dispatch + coexistence).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-persistent-player-and-queue/07-RESEARCH.md
@.planning/phases/07-persistent-player-and-queue/07-01-SUMMARY.md
@src/lib/components/TrackCard.svelte
@src/routes/+page.svelte
@src/routes/track/[slug]/+page.svelte
@src/lib/stores/playerState.svelte.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add play button to TrackCard and pass queue data from listing page</name>
  <files>src/lib/components/TrackCard.svelte, src/routes/+page.svelte</files>
  <action>
**TrackCard.svelte:**

1. Import `playerState` from `$lib/stores/playerState.svelte` and import `QueueTrack` type.
2. Add new props alongside existing `track` prop:
   - `allTracks?: QueueTrack[]` (optional, the full queue of visible tracks)
   - `index?: number` (optional, this card's position in the queue)
3. Create a `handlePlay` function:
   - Build a QueueTrack from the track prop: `{ id: track.id, slug: track.slug, title: track.title, duration: track.duration ?? 0, artPath: track.artPath }`
   - Call `playerState.play(queueTrack, allTracks ?? [queueTrack], index ?? 0)`
4. Add a play button to the card layout. Place it as the LAST element in the flex row (after the text content div), so it appears on the right side.
   - The button should call `handlePlay` on click.
   - CRITICAL: The button must use `e.preventDefault()` and `e.stopPropagation()` because TrackCard is wrapped in an `<a>` tag. Without this, clicking play would navigate to the track page instead of playing.
   - Style: A small circular button (w-8 h-8 rounded-full), bg-violet-600 hover:bg-violet-500, with a play triangle unicode (&#9654; or the string "Play"). Use `opacity-0 group-hover:opacity-100 transition-opacity` to show it only on hover (the parent `<a>` already has `group` class). On mobile, always show it: `md:opacity-0 md:group-hover:opacity-100` (visible by default on touch devices).
   - If `playerState.currentTrack?.id === track.id && playerState.isPlaying`, show a pause indicator instead (unicode &#9646;&#9646; or "||"). Clicking it should call `playerState.togglePlayPause()`.
   - If `playerState.currentTrack?.id === track.id && !playerState.isPlaying`, show play triangle but styled differently (e.g., ring around button) to indicate "this is the current track, paused."

**+page.svelte (listing page):**

1. Import `QueueTrack` type from playerState.
2. Create a `$derived` value `queueTracks` that maps `data.tracks` to `QueueTrack[]`:
   ```
   let queueTracks = $derived(data.tracks.map(t => ({
     id: t.id, slug: t.slug, title: t.title,
     duration: t.duration ?? 0, artPath: t.artPath
   })));
   ```
3. In the `{#each}` loop, pass `allTracks={queueTracks}` and the loop index to each TrackCard:
   ```
   {#each data.tracks as track, i (track.id)}
     <TrackCard {track} allTracks={queueTracks} index={i} />
   {/each}
   ```

This means clicking play on any card in the listing populates the queue with ALL currently visible (potentially filtered) tracks and starts playing from the clicked track's position.
  </action>
  <verify>Run `cd /home/user/wallybrain-music && npx svelte-check --tsconfig ./tsconfig.json 2>&1 | tail -20` -- no type errors in TrackCard.svelte or +page.svelte.</verify>
  <done>TrackCard has a play/pause button that dispatches to global playerState. Listing page passes full visible track list as queue data. Clicking play on a card starts the persistent player with the queue populated from all visible tracks.</done>
</task>

<task type="auto">
  <name>Task 2: Wire track detail page with play dispatch and WaveformPlayer coexistence</name>
  <files>src/routes/track/[slug]/+page.svelte</files>
  <action>
Modify the track detail page to:

1. Import `playerState` from `$lib/stores/playerState.svelte` and `QueueTrack` type.

2. Create a derived boolean for coexistence detection:
   ```
   let isPlayingThisTrack = $derived(playerState.currentTrack?.id === track.id);
   ```

3. Add a "Play in persistent player" button near the existing WaveformPlayer section. Place it next to (or instead of) the existing play mechanism:
   - If `isPlayingThisTrack` is true and `playerState.isPlaying`: Show a "Now Playing" indicator (text "Now Playing" with a pulsing dot or simple animated text). Also show a pause button that calls `playerState.togglePlayPause()`.
   - If `isPlayingThisTrack` is true and `!playerState.isPlaying`: Show "Paused" indicator and a resume button calling `playerState.togglePlayPause()`.
   - If `isPlayingThisTrack` is false: Show a play button that calls:
     ```
     playerState.play({
       id: track.id, slug: track.slug, title: track.title,
       duration: track.duration ?? 0, artPath: track.artPath
     })
     ```
     Queue for detail page play is just the single track (research recommendation for v1 simplicity).

4. Handle WaveformPlayer coexistence:
   - When `isPlayingThisTrack` is true: HIDE the WaveformPlayer component entirely. Replace it with the "Now Playing" indicator and playback controls (pause, time display). The persistent bottom bar already shows the waveform. Showing two wavesurfer instances for the same audio causes double playback.
   - When `isPlayingThisTrack` is false: Show the WaveformPlayer as normal (standalone preview for a different track). However, also add a prominent "Play" button (styled like a big play button, e.g., bg-violet-600 px-6 py-2 rounded-lg text-white font-medium) that dispatches to the persistent player instead. Keep the WaveformPlayer as a visual preview but make the primary CTA dispatch to the persistent player.

   Simplest correct approach: Replace the WaveformPlayer section with a conditional:
   ```svelte
   {#if isPlayingThisTrack}
     <div class="flex items-center gap-3 py-4">
       <button onclick={() => playerState.togglePlayPause()}
         class="px-4 py-1.5 rounded bg-violet-600 hover:bg-violet-500 text-white text-sm font-medium">
         {playerState.isPlaying ? 'Pause' : 'Resume'}
       </button>
       <span class="text-sm text-violet-400">Now playing in bottom player</span>
     </div>
   {:else}
     <WaveformPlayer trackId={track.id} duration={track.duration ?? 0} />
     <button onclick={playInPersistentPlayer}
       class="mt-2 text-xs text-zinc-500 hover:text-zinc-300">
       Play with continuous queue
     </button>
   {/if}
   ```

   This avoids double audio entirely. When the persistent player has this track, the page shows simple controls that delegate to the global state. When it doesn't, the standalone WaveformPlayer works as before.

5. Build passes. No double audio scenarios.
  </action>
  <verify>Run `cd /home/user/wallybrain-music && npx svelte-check --tsconfig ./tsconfig.json 2>&1 | tail -20` -- no errors. Then `cd /home/user/wallybrain-music && npm run build 2>&1 | tail -10` -- build succeeds.</verify>
  <done>Track detail page dispatches play to persistent player. When persistent player is playing this track, page-level WaveformPlayer is hidden and replaced with Now Playing indicator + pause/resume. When persistent player is playing a different track (or nothing), WaveformPlayer shows normally. No double audio playback. Build passes.</done>
</task>

</tasks>

<verification>
1. `npx svelte-check` reports no errors for modified files
2. `npm run build` succeeds
3. TrackCard.svelte has play button calling playerState.play() with queue data
4. +page.svelte passes allTracks and index to each TrackCard
5. Track detail page conditionally shows WaveformPlayer vs Now Playing indicator
6. Queue auto-advance works via finish event in PersistentPlayer (wired in Plan 01)
7. No double audio playback scenario possible
</verification>

<success_criteria>
- TrackCard shows play/pause button that dispatches to global playerState with full queue
- Listing page provides queue data (all visible tracks) to TrackCards
- Track detail page shows "Now Playing" when persistent player has that track loaded
- Track detail page shows normal WaveformPlayer when persistent player has a different track
- Clicking play on detail page dispatches to persistent player (single-track queue)
- Auto-play next track works when current track finishes (via finish event wired in Plan 01)
- Full navigation test: play track A from listing -> navigate to track B detail page -> audio A continues in bottom bar
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-persistent-player-and-queue/07-02-SUMMARY.md`
</output>
